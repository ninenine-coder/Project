<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 连接测试</title>
</head>
<body>
    <h1>Firebase 连接测试</h1>
    <div id="status">测试中...</div>
    <div id="scores"></div>

    <!-- 1. 先載入 firebase.js -->
    <script type="module" src="./js/firebase.js"></script>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { collection, query, where, orderBy, getDocs, signInAnonymously as fbSignInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        async function testFirebase() {
            const statusDiv = document.getElementById('status');
            const scoresDiv = document.getElementById('scores');
            
            try {
                console.log('🔍 开始 Firebase 测试...');
                statusDiv.textContent = 'Firebase 初始化成功';
                
                // 测试匿名登录
                if (!auth.currentUser) {
                    console.log('🔍 尝试匿名登录...');
                    await fbSignInAnonymously(auth);
                    console.log('✅ 匿名登录成功:', auth.currentUser.uid);
                    statusDiv.textContent = 'Firebase 初始化成功，匿名登录成功';
                }
                
                // 测试查询成绩
                console.log('🔍 开始查询成绩...');
                const q = query(
                    collection(db, "scores"),
                    where("uid", "==", auth.currentUser.uid),
                    orderBy("submittedAt", "desc")
                );
                
                const querySnapshot = await getDocs(q);
                console.log('📊 查询结果数量:', querySnapshot.size);
                
                if (querySnapshot.empty) {
                    scoresDiv.innerHTML = '<p>没有找到成绩记录</p>';
                    statusDiv.textContent += ' - 没有成绩记录';
                } else {
                    let html = '<h3>成绩记录:</h3><ul>';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        html += `<li>${data.score}分 - ${data.examType || '筆試測驗'} - ${data.submittedAt?.toDate()?.toLocaleString() || '無時間'}</li>`;
                    });
                    html += '</ul>';
                    scoresDiv.innerHTML = html;
                    statusDiv.textContent += ` - 找到 ${querySnapshot.size} 条成绩记录`;
                }
                
            } catch (error) {
                console.error('❌ Firebase 测试失败:', error);
                statusDiv.textContent = 'Firebase 测试失败: ' + error.message;
                statusDiv.style.color = 'red';
            }
        }
        
        // 页面加载后执行测试
        document.addEventListener('DOMContentLoaded', testFirebase);
    </script>
</body>
</html>
