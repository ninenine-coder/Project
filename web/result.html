<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>成績詳情</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto; max-width: 880px; margin: 40px auto; padding: 0 16px; }
    .meta { color:#555; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:16px 0; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; }
    table { width: 100%; border-collapse: collapse; margin-top:16px;}
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
    tr:hover { background:#faf7ff; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; background:#eee; font-size:12px; }
    .ok{ background:#e8f5e8; color:#2e7d32 }
    .ng{ background:#ffebee; color:#c62828 }
    .btn { display:inline-block; padding:8px 12px; border:1px solid #9c27b0; color:#9c27b0; border-radius:8px; text-decoration:none; }
    .btn:hover{ background:#9c27b0; color:#fff; }
  </style>
</head>
<body>
  <a class="btn" href="history.html">← 返回歷史成績</a>
  <h1 id="title">成績詳情</h1>
  <p class="meta" id="meta"></p>

  <div class="grid">
    <div class="card"><div>分數</div><strong id="score">-</strong></div>
    <div class="card"><div>答對 / 題數</div><strong id="solved">-</strong></div>
    <div class="card"><div>作答時間</div><strong id="duration">-</strong></div>
    <div class="card"><div>提交時間</div><strong id="submitted">-</strong></div>
  </div>

  <h3>作答詳解</h3>
  <table>
    <thead>
      <tr><th>#</th><th>你的答案</th><th>正確答案</th><th>結果</th><th>耗時</th></tr>
    </thead>
    <tbody id="answers"></tbody>
  </table>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBuWO8hFVjjTUe2tqJDrqdbeGTrp4PoT5Q",
      authDomain: "progect-115a5.firebaseapp.com",
      projectId: "progect-115a5"
    };
    const { initializeApp, getApps, getApp } =
      await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js");
    await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);

    const { loadOneResultWithAnswers } = await import("./js/results.js");

    const params = new URLSearchParams(location.search);
    const attemptId = params.get('attemptId');
    const me = JSON.parse(localStorage.getItem('pbls_user') || 'null');
    if (!me || !me.uid) { alert('請先登入'); location.href = 'login.html'; }

    if (!attemptId) { alert('缺少 attemptId'); location.href='history.html'; }

    const data = await loadOneResultWithAnswers({ uid: me.uid, attemptId });

    // 渲染摘要
    document.getElementById('title').textContent = data.examTitle || data.examId || '成績詳情';
    const ts = data.submittedAt?.toDate ? data.submittedAt.toDate() : null;
    const tstr = ts ? ts.toLocaleString() : '-';
    const pct = (data.scorePct != null) ? Math.round(data.scorePct * 100) + '%' : (data.scoreRaw ?? '-');
    document.getElementById('meta').textContent = `考試代碼：${data.examId || '-'} ｜ 嘗試 ID：${data.id}`;
    document.getElementById('score').textContent = pct;
    document.getElementById('solved').textContent = `${data.correctCount ?? '-'} / ${data.totalQuestions ?? '-'}`;
    document.getElementById('duration').textContent = data.durationSec != null ? `${Math.floor(data.durationSec/60)}分${data.durationSec%60}秒` : '-';
    document.getElementById('submitted').textContent = tstr;

    // 渲染詳解
    const tbody = document.getElementById('answers');
    tbody.innerHTML = (data.answers || []).map((a, idx) => {
      const ok = !!a.isCorrect;
      const badge = ok ? '<span class="badge ok">✔ 正確</span>' : '<span class="badge ng">✖ 錯誤</span>';
      const used = a.timeSec != null ? `${a.timeSec}s` : '-';
      return `<tr>
        <td>${a.qid || idx + 1}</td>
        <td>${a.selected ?? '-'}</td>
        <td>${a.correct ?? '-'}</td>
        <td>${badge}</td>
        <td>${used}</td>
      </tr>`;
    }).join('');
  </script>
</body>
</html>
