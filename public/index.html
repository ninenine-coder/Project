<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PBLS VR教學平台 - Google 登入</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin: 0;
            color: #333;
            overflow: hidden;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 2;
        }
        .login-header {
            margin-bottom: 30px;
        }
        .login-header .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .login-header .logo i {
            font-size: 3rem;
            color: #667eea;
            margin-right: 10px;
        }
        .login-header .logo h1 {
            font-size: 2.5rem;
            color: #333;
            margin: 0;
        }
        .login-header .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-top: 5px;
        }
        .g_id_signin {
            margin: 20px 0;
        }
        .demo-login-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }
        .demo-login-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .demo-login-btn:active {
            transform: scale(0.98);
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        #user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #667eea;
        }
        #user-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }
        .config-notice {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }
        .config-notice h3 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        .config-notice p {
            margin: 5px 0;
            font-size: 14px;
        }
        .config-notice code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* 註冊按鈕樣式 */
        .register-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 10px;
            text-decoration: none;
        }
        .register-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        .register-btn:active {
            transform: scale(0.98);
        }
        
        /* 註冊表單樣式 */
        .register-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .register-header {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .register-header .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .register-header .logo i {
            font-size: 2.5rem;
            color: #17a2b8;
            margin-right: 10px;
        }
        
        .register-header .logo h1 {
            font-size: 2rem;
            color: #333;
            margin: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
        }
        
        .form-group input.error,
        .form-group select.error {
            border-color: #dc3545;
        }
        
        .password-requirements {
            margin-top: 5px;
        }
        
        .password-requirements small {
            color: #666;
            font-size: 12px;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .cancel-btn,
        .submit-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        .submit-btn {
            background: #17a2b8;
            color: white;
        }
        
        .submit-btn:hover {
            background: #138496;
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* 遮罩層 */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .overlay.show {
            display: block;
      }
    </style>
  </head>
  <body>
    <!-- 用戶信息顯示 -->
    <div id="user-info">
        <img id="user-photo" src="" alt="user photo" />
        <span id="user-name"></span>
    </div>

    <!-- 遮罩層 -->
    <div id="overlay" class="overlay"></div>

    <div class="login-card">
        <div class="login-header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>PBLS</h1>
            </div>
            <p class="subtitle">VR教學平台</p>
        </div>

        <div class="config-notice">
            <h3>⚠️ 配置提醒</h3>
            <p>請在 Google Cloud Console 中設置 OAuth 2.0 客戶端 ID：</p>
            <p>1. 前往 <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></p>
            <p>2. 選擇專案或創建新專案</p>
            <p>3. 啟用 Google+ API</p>
            <p>4. 創建 OAuth 2.0 客戶端 ID</p>
            <p>5. 將 <code>YOUR_CLIENT_ID</code> 替換為實際的客戶端 ID</p>
        </div>

        <!-- Google Identity Services 登入按鈕 -->
        <div id="g_id_onload"
             data-client_id="YOUR_CLIENT_ID.apps.googleusercontent.com"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>

        <div class="g_id_signin" 
             data-type="standard"
             data-shape="rectangular"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>

        <!-- 演示登入按鈕 -->
        <button class="demo-login-btn" onclick="demoLogin()">
            <i class="fas fa-user-circle"></i>
            演示登入（無需 Google 配置）
        </button>

        <!-- 註冊按鈕 -->
        <a href="register.html" class="register-btn">
            <i class="fas fa-user-plus"></i>
            立即註冊
        </a>
    </div>

    <!-- 註冊表單 -->
    <div id="register-form" class="register-card" style="display: none;">
        <div class="register-header">
            <div class="logo">
                <i class="fas fa-user-plus"></i>
                <h1>註冊帳號</h1>
            </div>
            <p class="subtitle">請填寫以下資訊完成註冊</p>
        </div>

        <form id="registration-form" onsubmit="handleRegister(event)">
            <div class="form-group">
                <label for="email">電子郵件 *</label>
                <input type="email" id="email" name="email" required>
                <div class="error-message" id="email-error"></div>
            </div>

            <div class="form-group">
                <label for="password">密碼 *</label>
                <input type="password" id="password" name="password" required>
                <div class="password-requirements">
                    <small>密碼需包含：大小寫英文 + 數字</small>
                </div>
                <div class="error-message" id="password-error"></div>
            </div>

            <div class="form-group">
                <label for="confirm-password">確認密碼 *</label>
                <input type="password" id="confirm-password" name="confirm-password" required>
                <div class="error-message" id="confirm-password-error"></div>
            </div>

            <div class="form-group">
                <label for="name">姓名 *</label>
                <input type="text" id="name" name="name" required>
                <div class="error-message" id="name-error"></div>
            </div>

            <div class="form-group">
                <label for="where">所屬單位 *</label>
                <select id="where" name="where" required onchange="updateDepartments()">
                    <option value="">請選擇</option>
                    <option value="長庚大學">長庚大學</option>
                    <option value="長庚科大">長庚科大</option>
                    <option value="長庚醫院">長庚醫院</option>
                </select>
                <div class="error-message" id="where-error"></div>
            </div>

            <div class="form-group">
                <label for="department">部門 *</label>
                <select id="department" name="department" required>
                    <option value="">請先選擇所屬單位</option>
                </select>
                <div class="error-message" id="department-error"></div>
            </div>

            <div class="form-group">
                <label for="phone">電話/分機 *</label>
                <input type="tel" id="phone" name="phone" required placeholder="例如：03-2118800#1234">
                <div class="error-message" id="phone-error"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="cancel-btn" onclick="hideRegisterForm()">
                    <i class="fas fa-times"></i>
                    取消
                </button>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-user-plus"></i>
                    註冊
                </button>
            </div>
        </form>
    </div>

    <script>
        // 檢查登入狀態
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('pbls_user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    displayUserInfo(userData);
                    // 如果已登入，自動跳轉到主頁
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 100);
                } catch (e) {
                    console.error('解析用戶數據失敗:', e);
                    localStorage.removeItem('pbls_user');
                }
            }
        }

        // 顯示用戶信息
        function displayUserInfo(userData) {
            const userName = document.getElementById('user-name');
            const userPhoto = document.getElementById('user-photo');
            
            if (userName && userPhoto) {
                userName.textContent = userData.name || userData.displayName || '用戶';
                userPhoto.src = userData.photoURL || userData.photo || 'https://via.placeholder.com/40/667eea/ffffff?text=U';
                userPhoto.alt = userData.name || '用戶頭像';
                document.getElementById('user-info').style.display = 'flex';
            }
        }

        // Google Identity Services 回調函數
        function handleCredentialResponse(response) {
            console.log('Google 登入回應:', response);
            
            try {
                // 解析 JWT token
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c){
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                const user = JSON.parse(jsonPayload);
                console.log('使用者資訊:', user);
                
                // 保存用戶信息
                const userData = {
                    uid: user.sub,
                    email: user.email,
                    name: user.name,
                    displayName: user.name,
                    photoURL: user.picture,
                    loginTime: new Date().toISOString(),
                    loginMethod: 'google'
                };
                
                localStorage.setItem('pbls_user', JSON.stringify(userData));
                displayUserInfo(userData);
                
                // 顯示成功訊息
                alert('Google 登入成功！');
                
                // 跳轉到主頁
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
                
            } catch (error) {
                console.error('解析 Google 登入回應失敗:', error);
                alert('登入失敗，請重試');
            }
        }

        // 演示登入
        function demoLogin() {
            const demoBtn = event.target;
            const originalText = demoBtn.innerHTML;
            
            // 顯示載入狀態
            demoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
            demoBtn.disabled = true;
            
            setTimeout(() => {
                const userData = {
                    uid: 'demo-user-' + Date.now(),
                    email: 'demo@example.com',
                    name: '演示用戶',
                    displayName: '演示用戶',
                    photoURL: 'https://via.placeholder.com/40/28a745/ffffff?text=D',
                    loginTime: new Date().toISOString(),
                    loginMethod: 'demo'
                };
                
                localStorage.setItem('pbls_user', JSON.stringify(userData));
                displayUserInfo(userData);
                
                alert('演示登入成功！');
                
                // 跳轉到主頁
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            }, 1500);
        }

        // 登出功能
        function signOut() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.disableAutoSelect();
            }
            localStorage.removeItem('pbls_user');
            document.getElementById('user-info').style.display = 'none';
            console.log('使用者已登出');
        }

        // 部門選項配置
        const departmentOptions = {
            '長庚大學': ['資管系', '護理系', '醫學系'],
            '長庚科大': ['護理系'],
            '長庚醫院': ['小兒科']
        };

        // 顯示註冊表單
        function showRegisterForm() {
            console.log('showRegisterForm 函數被調用');
            try {
                const registerForm = document.getElementById('register-form');
                const overlay = document.getElementById('overlay');
                
                if (registerForm && overlay) {
                    registerForm.style.display = 'block';
                    overlay.classList.add('show');
                    document.body.style.overflow = 'hidden';
                    console.log('註冊表單已顯示');
                } else {
                    console.error('找不到註冊表單或遮罩層元素');
                    alert('找不到註冊表單元素！請檢查HTML結構。');
                }
            } catch (error) {
                console.error('顯示註冊表單時發生錯誤:', error);
                alert('顯示註冊表單時發生錯誤: ' + error.message);
            }
        }

        // 隱藏註冊表單
        function hideRegisterForm() {
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('overlay').classList.remove('show');
            document.body.style.overflow = 'auto';
            clearForm();
        }

        // 更新部門選項
        function updateDepartments() {
            const whereSelect = document.getElementById('where');
            const departmentSelect = document.getElementById('department');
            
            // 清空部門選項
            departmentSelect.innerHTML = '<option value="">請選擇部門</option>';
            
            if (whereSelect.value && departmentOptions[whereSelect.value]) {
                const departments = departmentOptions[whereSelect.value];
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });
            }
        }

        // 密碼強度驗證
        function validatePassword(password) {
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const minLength = password.length >= 8;
            
            return {
                valid: hasUpperCase && hasLowerCase && hasNumbers && minLength,
                errors: []
            };
        }

        // 顯示錯誤訊息
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + '-error');
            const inputElement = document.getElementById(fieldId);
            
            errorElement.textContent = message;
            errorElement.classList.add('show');
            inputElement.classList.add('error');
        }

        // 清除錯誤訊息
        function clearError(fieldId) {
            const errorElement = document.getElementById(fieldId + '-error');
            const inputElement = document.getElementById(fieldId);
            
            errorElement.textContent = '';
            errorElement.classList.remove('show');
            inputElement.classList.remove('error');
        }

        // 清除所有錯誤訊息
        function clearAllErrors() {
            const fields = ['email', 'password', 'confirm-password', 'name', 'where', 'department', 'phone'];
            fields.forEach(field => clearError(field));
        }

        // 清除表單
        function clearForm() {
            document.getElementById('registration-form').reset();
            clearAllErrors();
        }

        // 處理註冊表單提交
        function handleRegister(event) {
            event.preventDefault();
            clearAllErrors();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            
            let isValid = true;
            
            // 驗證電子郵件
            if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showError('email', '請輸入有效的電子郵件地址');
                isValid = false;
            }
            
            // 驗證密碼
            const passwordValidation = validatePassword(data.password);
            if (!passwordValidation.valid) {
                showError('password', '密碼需包含大小寫英文和數字，且至少8個字符');
                isValid = false;
            }
            
            // 驗證確認密碼
            if (data.password !== data['confirm-password']) {
                showError('confirm-password', '密碼與確認密碼不一致');
                isValid = false;
            }
            
            // 驗證姓名
            if (!data.name || data.name.trim().length < 2) {
                showError('name', '請輸入有效的姓名');
                isValid = false;
            }
            
            // 驗證所屬單位
            if (!data.where) {
                showError('where', '請選擇所屬單位');
                isValid = false;
            }
            
            // 驗證部門
            if (!data.department) {
                showError('department', '請選擇部門');
                isValid = false;
            }
            
            // 驗證電話
            if (!data.phone || data.phone.trim().length < 5) {
                showError('phone', '請輸入有效的電話號碼');
                isValid = false;
            }
            
            if (isValid) {
                // 模擬註冊成功
                const userData = {
                    uid: 'user-' + Date.now(),
                    email: data.email,
                    name: data.name,
                    displayName: data.name,
                    photoURL: 'https://via.placeholder.com/40/17a2b8/ffffff?text=' + data.name.charAt(0),
                    loginTime: new Date().toISOString(),
                    loginMethod: 'register',
                    where: data.where,
                    department: data.department,
                    phone: data.phone
                };
                
                // 保存用戶信息
                localStorage.setItem('pbls_user', JSON.stringify(userData));
                
                // 顯示成功訊息
                alert('註冊成功！歡迎加入PBLS VR教學平台！');
                
                // 隱藏註冊表單
                hideRegisterForm();
                
                // 顯示用戶信息
                displayUserInfo(userData);
                
                // 跳轉到主頁
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            }
        }

        // 點擊遮罩層關閉註冊表單
        document.getElementById('overlay').addEventListener('click', hideRegisterForm);

        // 頁面載入時檢查登入狀態
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始檢查登入狀態');
            try {
                checkLoginStatus();
            } catch (error) {
                console.error('檢查登入狀態時發生錯誤:', error);
        }
      });
    </script>
  </body>
</html>
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1000);
            }
        }

        // 點擊遮罩層關閉註冊表單
        document.getElementById('overlay').addEventListener('click', hideRegisterForm);

        // 頁面載入時檢查登入狀態
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始檢查登入狀態');
            try {
                checkLoginStatus();
            } catch (error) {
                console.error('檢查登入狀態時發生錯誤:', error);
        }
      });
    </script>
  </body>
</html>