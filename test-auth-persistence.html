<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯• Auth æŒä¹…åŒ–æœºåˆ¶</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .test-section h3 { margin-top: 0; color: #667eea; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #764ba2; }
        .log { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 6px; font-family: monospace; white-space: pre-wrap; font-size: 13px; border: 1px solid #e0e0e0; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Auth æŒä¹…åŒ–æœºåˆ¶æµ‹è¯•</h1>
    <p><strong>ç›®çš„ï¼š</strong>éªŒè¯ Firebase Auth åœ¨é¡µé¢åˆ·æ–°å’Œè·¨é¡µé¢æ—¶çš„æŒä¹…åŒ–è¡Œä¸ºã€‚</p>
    
    <div class="test-section">
        <h3>1. åˆå§‹åŒ–æ£€æŸ¥</h3>
        <button onclick="checkInit()">æ£€æŸ¥ Firebase åˆå§‹åŒ–</button>
        <div id="init-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h3>2. è®¤è¯çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkAuthState()">æ£€æŸ¥å½“å‰è®¤è¯çŠ¶æ€</button>
        <button onclick="testEnsureSignedIn()">æµ‹è¯• ensureSignedIn()</button>
        <div id="auth-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h3>3. æŒä¹…åŒ–æµ‹è¯•</h3>
        <button onclick="testPersistence()">æµ‹è¯•æŒä¹…åŒ–æœºåˆ¶</button>
        <button onclick="clearAndTest()">æ¸…é™¤æŒä¹…åŒ–æ•°æ®å¹¶é‡æ–°ç™»å½•</button>
        <div id="persist-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>
    
    <div class="test-section">
        <h3>4. è·¨é¡µé¢æµ‹è¯•</h3>
        <p>åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æ­¤é¡µé¢ï¼Œæ£€æŸ¥æ˜¯å¦èƒ½è‡ªåŠ¨è¿˜åŸåŒä¸€ç”¨æˆ·ï¼š</p>
        <button onclick="openNewTab()">åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€</button>
        <button onclick="location.reload()">åˆ·æ–°å½“å‰é¡µé¢</button>
        <div id="cross-log" class="log">
å½“å‰ UID: <span id="current-uid">-</span>
åŒ¿åçŠ¶æ€: <span id="is-anon">-</span>
        </div>
    </div>
    
    <div class="test-section">
        <h3>5. å­¦å·/å·¥å·æµ‹è¯•</h3>
        <button onclick="setTestProfile()">è®¾ç½®æµ‹è¯•å­¦å·</button>
        <button onclick="checkUserKey()">æ£€æŸ¥å½“å‰å­¦å·/å·¥å·</button>
        <button onclick="clearProfile()">æ¸…é™¤å­¦å·/å·¥å·</button>
        <div id="profile-log" class="log">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <script type="module">
        import { auth, db, authReady } from './js/firebase.js';
        import { ensureSignedIn, getUserKey } from './js/auth-helpers.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        onAuthStateChanged(auth, (user) => {
            const uidEl = document.getElementById('current-uid');
            const anonEl = document.getElementById('is-anon');
            if (user) {
                uidEl.textContent = user.uid;
                anonEl.textContent = user.isAnonymous ? 'æ˜¯' : 'å¦';
                console.log('ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–:', user.isAnonymous ? 'åŒ¿å-' + user.uid : user.email || user.uid);
            } else {
                uidEl.textContent = 'æœªç™»å½•';
                anonEl.textContent = '-';
                console.log('ğŸ” è®¤è¯çŠ¶æ€å˜åŒ–: æœªç™»å½•');
            }
        });

        // 1. æ£€æŸ¥åˆå§‹åŒ–
        window.checkInit = async function() {
            const log = document.getElementById('init-log');
            try {
                log.className = 'log';
                log.textContent = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥...';
                
                await authReady;
                
                const result = `âœ… Firebase åˆå§‹åŒ–æˆåŠŸ
                
Auth å®ä¾‹: ${!!auth}
DB å®ä¾‹: ${!!db}
å½“å‰ç”¨æˆ·: ${auth.currentUser ? (auth.currentUser.isAnonymous ? 'åŒ¿å-' + auth.currentUser.uid : auth.currentUser.email || auth.currentUser.uid) : 'æœªç™»å½•'}
æŒä¹…åŒ–ç±»å‹: ${auth.config?.persistence?.[0]?.type || 'local'}`;
                
                log.textContent = result;
                log.className = 'log success';
            } catch (error) {
                log.textContent = `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
                log.className = 'log error';
            }
        };

        // 2. æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.checkAuthState = async function() {
            const log = document.getElementById('auth-log');
            try {
                log.className = 'log';
                log.textContent = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥...';
                
                await authReady;
                
                if (auth.currentUser) {
                    const result = `âœ… ç”¨æˆ·å·²ç™»å½•
                    
UID: ${auth.currentUser.uid}
åŒ¿å: ${auth.currentUser.isAnonymous}
Email: ${auth.currentUser.email || 'æ— '}
åˆ›å»ºæ—¶é—´: ${new Date(auth.currentUser.metadata.creationTime).toLocaleString('zh-TW')}
æœ€åç™»å½•: ${new Date(auth.currentUser.metadata.lastSignInTime).toLocaleString('zh-TW')}`;
                    
                    log.textContent = result;
                    log.className = 'log success';
                } else {
                    log.textContent = 'âš ï¸ å½“å‰æœªç™»å½•';
                    log.className = 'log info';
                }
            } catch (error) {
                log.textContent = `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`;
                log.className = 'log error';
            }
        };

        // æµ‹è¯• ensureSignedIn
        window.testEnsureSignedIn = async function() {
            const log = document.getElementById('auth-log');
            try {
                log.className = 'log';
                log.textContent = 'ğŸ”„ æ­£åœ¨è°ƒç”¨ ensureSignedIn()...';
                
                const user = await ensureSignedIn();
                
                const result = `âœ… ensureSignedIn() æˆåŠŸ
                
è¿”å›ç”¨æˆ· UID: ${user.uid}
åŒ¿åçŠ¶æ€: ${user.isAnonymous}
æ˜¯å¦æ–°åˆ›å»º: ${!auth.currentUser || auth.currentUser.uid !== user.uid ? 'å¦ï¼ˆå·²è¿˜åŸï¼‰' : 'å¯èƒ½ï¼ˆéœ€æ£€æŸ¥ï¼‰'}`;
                
                log.textContent = result;
                log.className = 'log success';
            } catch (error) {
                log.textContent = `âŒ ensureSignedIn() å¤±è´¥: ${error.message}`;
                log.className = 'log error';
            }
        };

        // 3. æµ‹è¯•æŒä¹…åŒ–
        window.testPersistence = async function() {
            const log = document.getElementById('persist-log');
            try {
                log.className = 'log';
                log.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•æŒä¹…åŒ–æœºåˆ¶...';
                
                const beforeUID = auth.currentUser?.uid;
                
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œå…ˆç™»å½•
                if (!beforeUID) {
                    await ensureSignedIn();
                }
                
                const afterUID = auth.currentUser?.uid;
                
                const result = `âœ… æŒä¹…åŒ–æµ‹è¯•å®Œæˆ
                
æµ‹è¯•å‰ UID: ${beforeUID || 'æ— '}
æµ‹è¯•å UID: ${afterUID}
æŒä¹…åŒ–çŠ¶æ€: ${beforeUID && beforeUID === afterUID ? 'âœ… å·²ä¿å­˜ï¼ˆåŒä¸€ç”¨æˆ·ï¼‰' : 'âš ï¸ æ–°ç™»å½•æˆ–ä¸åŒç”¨æˆ·'}

ğŸ’¡ æç¤ºï¼šåˆ·æ–°é¡µé¢åå†æ¬¡æ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œå¦‚æœ UID ç›¸åŒï¼Œè¯´æ˜æŒä¹…åŒ–æˆåŠŸã€‚`;
                
                log.textContent = result;
                log.className = 'log success';
            } catch (error) {
                log.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                log.className = 'log error';
            }
        };

        // æ¸…é™¤å¹¶é‡æ–°ç™»å½•
        window.clearAndTest = async function() {
            const log = document.getElementById('persist-log');
            try {
                log.className = 'log';
                log.textContent = 'ğŸ”„ æ­£åœ¨æ¸…é™¤æŒä¹…åŒ–æ•°æ®...';
                
                const oldUID = auth.currentUser?.uid;
                
                // ç™»å‡º
                await auth.signOut();
                console.log('âœ… å·²ç™»å‡º');
                
                // ç­‰å¾…ä¸€ä¼šå„¿
                await new Promise(r => setTimeout(r, 500));
                
                // é‡æ–°ç™»å½•
                const user = await ensureSignedIn();
                
                const result = `âœ… æ¸…é™¤å¹¶é‡æ–°ç™»å½•å®Œæˆ
                
åŸ UID: ${oldUID || 'æ— '}
æ–° UID: ${user.uid}
æ˜¯å¦ç›¸åŒ: ${oldUID === user.uid ? 'æ˜¯ï¼ˆå¯èƒ½æ˜¯ç¼“å­˜ï¼‰' : 'å¦ï¼ˆæ–°åˆ›å»ºï¼‰'}

ğŸ’¡ æç¤ºï¼šåŒ¿åè´¦æˆ·åœ¨ç™»å‡ºåé€šå¸¸ä¼šåˆ›å»ºæ–°çš„ UIDã€‚`;
                
                log.textContent = result;
                log.className = 'log success';
            } catch (error) {
                log.textContent = `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`;
                log.className = 'log error';
            }
        };

        // 4. æ‰“å¼€æ–°æ ‡ç­¾é¡µ
        window.openNewTab = function() {
            window.open(window.location.href, '_blank');
        };

        // 5. è®¾ç½®æµ‹è¯•å­¦å·
        window.setTestProfile = function() {
            const log = document.getElementById('profile-log');
            const testProfile = {
                'å­¦å·': 'TEST123456',
                'å·¥å·': null,
                'name': 'æµ‹è¯•ç”¨æˆ·'
            };
            localStorage.setItem('pbls_user_profile', JSON.stringify(testProfile));
            log.textContent = `âœ… å·²è®¾ç½®æµ‹è¯•å­¦å·: ${testProfile['å­¦å·']}`;
            log.className = 'log success';
        };

        // æ£€æŸ¥å­¦å·/å·¥å·
        window.checkUserKey = function() {
            const log = document.getElementById('profile-log');
            const userKey = getUserKey();
            if (userKey) {
                log.textContent = `âœ… å½“å‰å­¦å·/å·¥å·: ${userKey}\n\nlocalStorage å†…å®¹:\n${localStorage.getItem('pbls_user_profile')}`;
                log.className = 'log success';
            } else {
                log.textContent = 'âš ï¸ æœªæ‰¾åˆ°å­¦å·/å·¥å·\n\nè¯·å…ˆè®¾ç½®æµ‹è¯•å­¦å·';
                log.className = 'log info';
            }
        };

        // æ¸…é™¤å­¦å·/å·¥å·
        window.clearProfile = function() {
            const log = document.getElementById('profile-log');
            localStorage.removeItem('pbls_user_profile');
            log.textContent = 'âœ… å·²æ¸…é™¤å­¦å·/å·¥å·æ•°æ®';
            log.className = 'log success';
        };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', async () => {
            await checkInit();
            await checkAuthState();
        });
    </script>
</body>
</html>
