<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯• handleExamFinish å‡½æ•°</title>
</head>
<body>
    <h1>æµ‹è¯• handleExamFinish å‡½æ•°</h1>
    <button onclick="testHandleExamFinish()">æµ‹è¯•å‡½æ•°</button>
    <div id="result"></div>

    <!-- 1. å…ˆè¼‰å…¥ firebase.js -->
    <script type="module" src="./js/firebase.js"></script>
    
    <!-- 2. è¼‰å…¥æ¸¬é©—çµæœæœå‹™ -->
    <script type="module">
        import './src/services/userDataService.js';
    </script>
    
    <!-- 3. è¼‰å…¥ handleExamFinish å‡½æ•¸ -->
    <script type="module">
      import { auth, db } from './js/firebase.js';
      import {
        collection, addDoc, serverTimestamp, setDoc, doc, getDocs, query, orderBy, documentId, limit
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
      import {
        onAuthStateChanged, signInAnonymously as fbSignInAnonymously
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      function ensureFirebase() {
        return {
          app: window.__FB__.app,
          db: db,
          auth: auth,
        };
      }

      // è‹¥æœªç™»å…¥å°±ç”¨åŒ¿åç™»å…¥
      async function ensureSignedIn(auth) {
        if (auth.currentUser) return auth.currentUser;
        try {
          const cred = await fbSignInAnonymously(auth);
          console.log("ğŸ” å·²åŒ¿åç™»å…¥ï¼š", cred.user.uid);
          return cred.user;
        } catch (e) {
          console.error("âŒ åŒ¿åç™»å…¥å¤±æ•—ï¼š", e.code, e.message);
          throw e;
        }
      }

      // å–ç”¨æˆ¶åï¼ˆè‹¥ç„¡å‰‡ç”¨ã€Œæœªå‘½åä½¿ç”¨è€…ã€ï¼‰
      function resolveUserName() {
        try {
          const p = JSON.parse(localStorage.getItem("pbls_user_profile") || "null");
          if (p?.name) return p.name;
        } catch {}
        return (window.currentUserName && String(window.currentUserName)) || "æœªå‘½åä½¿ç”¨è€…";
      }

      // ç²å–ä¸‹ä¸€å€‹ scores åºè™Ÿ
      async function getNextScoreId(db) {
        try {
          const q = query(collection(db, "scores"), orderBy(documentId(), "desc"), limit(1));
          const snap = await getDocs(q);
          if (snap.empty) return 1;
          const lastId = snap.docs[0].id;
          const match = lastId.match(/^scores(\d+)$/);
          const maxId = match ? parseInt(match[1]) : 0;
          const nextId = maxId + 1;
          console.log("ğŸ“Š å‚™ç”¨æ–¹æ³•ç²å–çš„ä¸‹ä¸€å€‹åºè™Ÿ:", nextId);
          return nextId;
        } catch (error) {
          console.error("âŒ ç²å–åºè™Ÿå¤±æ•—:", error);
          console.log("ğŸ“Š ä½¿ç”¨é»˜èªåºè™Ÿ: 1");
          return 1;
        }
      }

      // === å°‡é€™å€‹æ–¹æ³•æ›åˆ° windowï¼Œäº¤å·æ™‚å‘¼å«å®ƒ ===
      async function handleExamFinish(finalScore, timeSpentMs, startedAtMs, correctCount, questionCount) {
        const { db, auth } = ensureFirebase();
        try {
          const user = await ensureSignedIn(auth); // â† ç¢ºä¿ request.auth != null
          const userName = resolveUserName();
          console.log("ğŸ‘¤ ä½¿ç”¨è€…ï¼š", userName, "ï½œåˆ†æ•¸ï¼š", finalScore);
          console.log("ğŸ” ç”¨æˆ¶ UIDï¼š", user.uid);
          console.log("â±ï¸ è€—æ™‚ï¼š", timeSpentMs, "ms");
          console.log("ğŸ“Š ç­”å°/ç¸½é¡Œæ•¸ï¼š", correctCount, "/", questionCount);

          // ç²å–ä¸‹ä¸€å€‹åºè™Ÿ
          const nextScoreId = await getNextScoreId(db);
          console.log("ğŸ“Š ä¸‹ä¸€å€‹åºè™Ÿï¼š", nextScoreId);

          const data = { 
            uid: user.uid,                           // â˜… å¿…å¡«ï¼Œèˆ‡ Rules æ¯”å°
            userName,                                // ä½¿ç”¨è€…åç¨±ï¼ˆé¡¯ç¤ºç”¨ï¼‰
            score: Math.round(Number(finalScore)),   // åˆ†æ•¸ï¼ˆæ•´æ•¸ï¼‰
            timeSpentMs: Math.max(0, Math.floor(timeSpentMs || 0)), // ç¸½è€—æ™‚ï¼ˆæ¯«ç§’ï¼‰
            startedAt: startedAtMs ? Math.floor(startedAtMs) : null, // é–‹å§‹æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
            correctCount: Number.isInteger(correctCount) ? correctCount : null, // ç­”å°æ•¸
            questionCount: Number.isInteger(questionCount) ? questionCount : null, // é¡Œæ•¸
            examType: "ç­†è©¦æ¸¬é©—",                      // æ¸¬é©—é¡å‹
            submittedAt: serverTimestamp(),          // æäº¤æ™‚é–“ï¼ˆä¼ºæœå™¨æ™‚é–“ï¼‰
            clientInfo: {                           // é¡å¤–è³‡è¨Š
              userAgent: navigator.userAgent,
              timestamp: Date.now()
            }
          };

          console.log("ğŸ“Š æº–å‚™å¯«å…¥è³‡æ–™ï¼š", data);

          // ä½¿ç”¨æœ‰åºçš„ document ID
          const docRef = doc(db, "scores", `scores${nextScoreId}`);
          await setDoc(docRef, data);

          console.log(`âœ… æˆç¸¾å·²æˆåŠŸä¿å­˜åˆ° scores é›†åˆï¼Œæ–‡ä»¶ ID: scores${nextScoreId}`);
          return true;
        } catch (error) {
          console.error("âŒ ä¿å­˜æˆç¸¾å¤±æ•—ï¼š", error);
          console.error("éŒ¯èª¤è©³æƒ…ï¼š", {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          return false;
        }
      }

      // è§€å¯Ÿç™»å…¥ç‹€æ…‹ï¼ˆå¯çœ‹åˆ°æ˜¯å¦åŒ¿åç™»å…¥æˆåŠŸï¼‰
      const { auth } = ensureFirebase();
      onAuthStateChanged(auth, (u) => {
        console.log("ğŸ” auth ç‹€æ…‹ï¼š", u ? (u.isAnonymous ? "åŒ¿å-" + u.uid : (u.email || u.uid)) : "æœªç™»å…¥");
      });

      // å°‡å‡½æ•¸æš´éœ²åˆ° window å°è±¡ï¼Œä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
      window.handleExamFinish = handleExamFinish;
      console.log("âœ… handleExamFinish å‡½æ•¸å·²æš´éœ²åˆ° window å°è±¡");
    </script>

    <script>
        function testHandleExamFinish() {
            const resultDiv = document.getElementById('result');
            
            if (typeof window.handleExamFinish === 'function') {
                resultDiv.innerHTML = '<p style="color: green;">âœ… handleExamFinish å‡½æ•¸å­˜åœ¨ï¼</p>';
                
                // æ¸¬è©¦èª¿ç”¨
                window.handleExamFinish(85, 12000, Date.now() - 12000, 17, 20)
                    .then(success => {
                        if (success) {
                            resultDiv.innerHTML += '<p style="color: green;">âœ… æ¸¬è©¦æˆç¸¾ä¿å­˜æˆåŠŸï¼</p>';
                        } else {
                            resultDiv.innerHTML += '<p style="color: red;">âŒ æ¸¬è©¦æˆç¸¾ä¿å­˜å¤±æ•—ï¼</p>';
                        }
                    })
                    .catch(error => {
                        resultDiv.innerHTML += '<p style="color: red;">âŒ æ¸¬è©¦æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message + '</p>';
                    });
            } else {
                resultDiv.innerHTML = '<p style="color: red;">âŒ handleExamFinish å‡½æ•¸ä¸å­˜åœ¨ï¼</p>';
            }
        }
    </script>
</body>
</html>
