<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 handleExamFinish 函数</title>
</head>
<body>
    <h1>测试 handleExamFinish 函数</h1>
    <button onclick="testHandleExamFinish()">测试函数</button>
    <div id="result"></div>

    <!-- 1. 先載入 firebase.js -->
    <script type="module" src="./js/firebase.js"></script>
    
    <!-- 2. 載入測驗結果服務 -->
    <script type="module">
        import './src/services/userDataService.js';
    </script>
    
    <!-- 3. 載入 handleExamFinish 函數 -->
    <script type="module">
      import { auth, db } from './js/firebase.js';
      import {
        collection, addDoc, serverTimestamp, setDoc, doc, getDocs, query, orderBy, documentId, limit
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
      import {
        onAuthStateChanged, signInAnonymously as fbSignInAnonymously
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      function ensureFirebase() {
        return {
          app: window.__FB__.app,
          db: db,
          auth: auth,
        };
      }

      // 若未登入就用匿名登入
      async function ensureSignedIn(auth) {
        if (auth.currentUser) return auth.currentUser;
        try {
          const cred = await fbSignInAnonymously(auth);
          console.log("🔐 已匿名登入：", cred.user.uid);
          return cred.user;
        } catch (e) {
          console.error("❌ 匿名登入失敗：", e.code, e.message);
          throw e;
        }
      }

      // 取用戶名（若無則用「未命名使用者」）
      function resolveUserName() {
        try {
          const p = JSON.parse(localStorage.getItem("pbls_user_profile") || "null");
          if (p?.name) return p.name;
        } catch {}
        return (window.currentUserName && String(window.currentUserName)) || "未命名使用者";
      }

      // 獲取下一個 scores 序號
      async function getNextScoreId(db) {
        try {
          const q = query(collection(db, "scores"), orderBy(documentId(), "desc"), limit(1));
          const snap = await getDocs(q);
          if (snap.empty) return 1;
          const lastId = snap.docs[0].id;
          const match = lastId.match(/^scores(\d+)$/);
          const maxId = match ? parseInt(match[1]) : 0;
          const nextId = maxId + 1;
          console.log("📊 備用方法獲取的下一個序號:", nextId);
          return nextId;
        } catch (error) {
          console.error("❌ 獲取序號失敗:", error);
          console.log("📊 使用默認序號: 1");
          return 1;
        }
      }

      // === 將這個方法掛到 window，交卷時呼叫它 ===
      async function handleExamFinish(finalScore, timeSpentMs, startedAtMs, correctCount, questionCount) {
        const { db, auth } = ensureFirebase();
        try {
          const user = await ensureSignedIn(auth); // ← 確保 request.auth != null
          const userName = resolveUserName();
          console.log("👤 使用者：", userName, "｜分數：", finalScore);
          console.log("🔐 用戶 UID：", user.uid);
          console.log("⏱️ 耗時：", timeSpentMs, "ms");
          console.log("📊 答對/總題數：", correctCount, "/", questionCount);

          // 獲取下一個序號
          const nextScoreId = await getNextScoreId(db);
          console.log("📊 下一個序號：", nextScoreId);

          const data = { 
            uid: user.uid,                           // ★ 必填，與 Rules 比對
            userName,                                // 使用者名稱（顯示用）
            score: Math.round(Number(finalScore)),   // 分數（整數）
            timeSpentMs: Math.max(0, Math.floor(timeSpentMs || 0)), // 總耗時（毫秒）
            startedAt: startedAtMs ? Math.floor(startedAtMs) : null, // 開始時間（毫秒）
            correctCount: Number.isInteger(correctCount) ? correctCount : null, // 答對數
            questionCount: Number.isInteger(questionCount) ? questionCount : null, // 題數
            examType: "筆試測驗",                      // 測驗類型
            submittedAt: serverTimestamp(),          // 提交時間（伺服器時間）
            clientInfo: {                           // 額外資訊
              userAgent: navigator.userAgent,
              timestamp: Date.now()
            }
          };

          console.log("📊 準備寫入資料：", data);

          // 使用有序的 document ID
          const docRef = doc(db, "scores", `scores${nextScoreId}`);
          await setDoc(docRef, data);

          console.log(`✅ 成績已成功保存到 scores 集合，文件 ID: scores${nextScoreId}`);
          return true;
        } catch (error) {
          console.error("❌ 保存成績失敗：", error);
          console.error("錯誤詳情：", {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          return false;
        }
      }

      // 觀察登入狀態（可看到是否匿名登入成功）
      const { auth } = ensureFirebase();
      onAuthStateChanged(auth, (u) => {
        console.log("🔐 auth 狀態：", u ? (u.isAnonymous ? "匿名-" + u.uid : (u.email || u.uid)) : "未登入");
      });

      // 將函數暴露到 window 對象，供其他腳本使用
      window.handleExamFinish = handleExamFinish;
      console.log("✅ handleExamFinish 函數已暴露到 window 對象");
    </script>

    <script>
        function testHandleExamFinish() {
            const resultDiv = document.getElementById('result');
            
            if (typeof window.handleExamFinish === 'function') {
                resultDiv.innerHTML = '<p style="color: green;">✅ handleExamFinish 函數存在！</p>';
                
                // 測試調用
                window.handleExamFinish(85, 12000, Date.now() - 12000, 17, 20)
                    .then(success => {
                        if (success) {
                            resultDiv.innerHTML += '<p style="color: green;">✅ 測試成績保存成功！</p>';
                        } else {
                            resultDiv.innerHTML += '<p style="color: red;">❌ 測試成績保存失敗！</p>';
                        }
                    })
                    .catch(error => {
                        resultDiv.innerHTML += '<p style="color: red;">❌ 測試時發生錯誤：' + error.message + '</p>';
                    });
            } else {
                resultDiv.innerHTML = '<p style="color: red;">❌ handleExamFinish 函數不存在！</p>';
            }
        }
    </script>
</body>
</html>
