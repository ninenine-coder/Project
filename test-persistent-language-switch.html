<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>持續語言切換測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        .problem-section {
            background: rgba(255, 152, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        .solution-section {
            background: rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .technical-details {
            background: rgba(255, 193, 7, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
            font-family: 'Courier New', monospace;
        }
        .checklist {
            background: rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        .checklist ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .checklist li {
            margin: 5px 0;
        }
        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .scenario-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }
        .scenario-card.before {
            border-left: 4px solid #ff9800;
        }
        .scenario-card.after {
            border-left: 4px solid #4CAF50;
        }
        .comparison-table {
            background: rgba(33, 150, 243, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #2196f3;
        }
        .comparison-table table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background: rgba(255, 255, 255, 0.2);
        }
        .debug-info {
            background: rgba(156, 39, 176, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #9c27b0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .flow-diagram {
            background: rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4CAF50;
        }
        .flow-diagram .flow-step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #4CAF50;
        }
        .flow-diagram .flow-arrow {
            text-align: center;
            font-size: 20px;
            color: #4CAF50;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 持續語言切換測試</h1>
        
        <div class="test-section">
            <h2>🎯 問題描述</h2>
            <div class="problem-section">
                <h3>❌ 觀察到的問題</h3>
                <p>用戶反映：<strong>"我在將英文轉換成中文時，他只有一題改變，等到下一題後，又變回英文"</strong></p>
                <ul>
                    <li>✅ 當前題目能正確切換語言</li>
                    <li>❌ 進入下一題後，題目又變回原來的語言</li>
                    <li>❌ 語言切換效果不持續</li>
                </ul>
                <p><strong>問題原因：</strong>只更新了當前題目的語言版本，沒有更新整個題目數組，導致後續題目仍使用原始語言版本。</p>
            </div>
        </div>

        <div class="test-section">
            <h2>🔧 解決方案</h2>
            <div class="solution-section">
                <h3>✅ 核心修復邏輯</h3>
                <div class="flow-diagram">
                    <div class="flow-step"><strong>1. 語言切換觸發</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>2. 載入新語言題目文件</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>3. 獲取原始題目ID列表</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>4. 根據ID從新語言文件中匹配題目</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>5. 更新整個 selectedQuestions 數組</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>6. 顯示當前題目（新語言版本）</strong></div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step"><strong>7. 後續所有題目都使用新語言版本</strong></div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>⚙️ 技術實現詳情</h2>
            <div class="technical-details">
<h4>修復前的問題：</h4>
<pre>// 只更新當前題目
selectedQuestions[currentQuestionIndex] = newQuestion;
// 問題：其他題目仍使用原始語言版本</pre>

<h4>修復後的解決方案：</h4>
<pre>// 獲取原始題目ID列表
const originalQuestionIds = selectedQuestions.map(q => q.id);
const updatedQuestions = [];

// 根據ID從新語言文件中匹配所有題目
for (let i = 0; i < originalQuestionIds.length; i++) {
  const originalId = originalQuestionIds[i];
  const newQuestion = newQuestions.find(q => q.id === originalId);
  if (newQuestion) {
    updatedQuestions.push(newQuestion);
  } else {
    updatedQuestions.push(selectedQuestions[i]); // 備用方案
  }
}

// 更新整個數組
selectedQuestions = updatedQuestions;</pre>

<h4>關鍵改進點：</h4>
<pre>1. 保持題目順序和ID不變
2. 更新整個 selectedQuestions 數組
3. 確保所有後續題目都使用新語言版本
4. 提供備用方案處理找不到對應題目的情況</pre>
            </div>
        </div>

        <div class="test-section">
            <h2>📊 修復前後對比</h2>
            <div class="scenario-grid">
                <div class="scenario-card before">
                    <h4>❌ 修復前</h4>
                    <p><strong>問題流程：</strong></p>
                    <ol>
                        <li>開始測驗（中文）</li>
                        <li>切換為英文</li>
                        <li>第1題顯示英文 ✅</li>
                        <li>回答第1題，進入第2題</li>
                        <li>第2題顯示中文 ❌</li>
                        <li>第3題顯示中文 ❌</li>
                        <li>所有後續題目都是中文 ❌</li>
                    </ol>
                    <p><strong>原因：</strong>只更新了當前題目，其他題目仍使用原始中文版本</p>
                </div>
                
                <div class="scenario-card after">
                    <h4>✅ 修復後</h4>
                    <p><strong>正確流程：</strong></p>
                    <ol>
                        <li>開始測驗（中文）</li>
                        <li>切換為英文</li>
                        <li>第1題顯示英文 ✅</li>
                        <li>回答第1題，進入第2題</li>
                        <li>第2題顯示英文 ✅</li>
                        <li>第3題顯示英文 ✅</li>
                        <li>所有後續題目都是英文 ✅</li>
                    </ol>
                    <p><strong>解決方案：</strong>更新整個題目數組，確保所有題目都使用新語言版本</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>📊 詳細對比表</h2>
            <div class="comparison-table">
                <table>
                    <thead>
                        <tr>
                            <th>題目編號</th>
                            <th>修復前（切換後）</th>
                            <th>修復後（切換後）</th>
                            <th>狀態</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>第1題</strong></td>
                            <td>✅ 英文</td>
                            <td>✅ 英文</td>
                            <td>✅ 正常</td>
                        </tr>
                        <tr>
                            <td><strong>第2題</strong></td>
                            <td>❌ 中文</td>
                            <td>✅ 英文</td>
                            <td>🔧 已修復</td>
                        </tr>
                        <tr>
                            <td><strong>第3題</strong></td>
                            <td>❌ 中文</td>
                            <td>✅ 英文</td>
                            <td>🔧 已修復</td>
                        </tr>
                        <tr>
                            <td><strong>第4題</strong></td>
                            <td>❌ 中文</td>
                            <td>✅ 英文</td>
                            <td>🔧 已修復</td>
                        </tr>
                        <tr>
                            <td><strong>第5題</strong></td>
                            <td>❌ 中文</td>
                            <td>✅ 英文</td>
                            <td>🔧 已修復</td>
                        </tr>
                        <tr>
                            <td><strong>...</strong></td>
                            <td>❌ 中文</td>
                            <td>✅ 英文</td>
                            <td>🔧 已修復</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 測試步驟</h2>
            <div class="checklist">
                <h3>📋 完整測試流程</h3>
                <ol>
                    <li><strong>準備測試環境</strong>
                        <ul>
                            <li>確保有中英文題目文件（questions.json 和 questions_en.json）</li>
                            <li>前往筆試測驗頁面</li>
                            <li>開啟開發者工具 Console 標籤</li>
                        </ul>
                    </li>
                    
                    <li><strong>測試持續語言切換</strong>
                        <ul>
                            <li>開始測驗（預設中文）</li>
                            <li>記錄第1題的中文內容</li>
                            <li>點擊語言切換按鈕切換為英文</li>
                            <li>確認第1題切換為英文</li>
                            <li>回答第1題，進入第2題</li>
                            <li>確認第2題是英文版本</li>
                            <li>繼續回答第3、4、5題</li>
                            <li>確認所有題目都是英文版本</li>
                        </ul>
                    </li>
                    
                    <li><strong>測試反向切換</strong>
                        <ul>
                            <li>在英文測驗進行中</li>
                            <li>點擊語言切換按鈕切換為中文</li>
                            <li>確認當前題目切換為中文</li>
                            <li>進入下一題</li>
                            <li>確認下一題也是中文版本</li>
                            <li>繼續測試後續題目</li>
                        </ul>
                    </li>
                    
                    <li><strong>測試多次切換</strong>
                        <ul>
                            <li>在測驗進行中多次切換語言</li>
                            <li>確認每次切換後所有後續題目都使用新語言</li>
                            <li>確認題目內容正確且功能正常</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h2>🎯 快速測試</h2>
            <button class="button" onclick="goToQuiz()">🧪 前往筆試測驗</button>
            <button class="button" onclick="testPersistentSwitch()">🔄 測試持續語言切換</button>
            <button class="button" onclick="testReverseSwitch()">↩️ 測試反向切換</button>
            <button class="button" onclick="testMultipleSwitch()">🔄 測試多次切換</button>
        </div>

        <div class="status" id="status">
            <strong>測試狀態：</strong>等待測試...
        </div>

        <div class="test-section">
            <h2>🔍 預期調試信息</h2>
            <div class="debug-info">
<h4>在開發者工具 Console 中應該看到的調試信息：</h4>
<pre>// 語言切換時
displayCurrentQuestionAfterLanguageSwitch: currentQuestionIndex = 0
Loading question file: data/questions_en.json
Updated entire selectedQuestions array with new language
Current question: What should you do first when someone is found collapsed?

// 進入下一題時
displayQuestion: showing question 2: What is the correct compression depth during CPR?
displayQuestion: created 4 options

// 再次語言切換時
displayCurrentQuestionAfterLanguageSwitch: currentQuestionIndex = 1
Loading question file: data/questions.json
Updated entire selectedQuestions array with new language
Current question: 什麼是CPR的正確按壓深度？</pre>

<h4>關鍵調試信息：</h4>
<pre>✅ "Updated entire selectedQuestions array with new language" - 確認整個數組已更新
✅ "Current question: [新語言題目]" - 確認當前題目使用新語言
✅ 後續題目都顯示新語言版本</pre>
            </div>
        </div>

        <div class="test-section">
            <h2>📊 預期結果</h2>
            <div class="checklist">
                <h3>✅ 修復後應該正常工作的功能</h3>
                <ul>
                    <li><strong>持續語言切換</strong>：語言切換後，所有後續題目都使用新語言版本</li>
                    <li><strong>題目順序保持</strong>：題目順序和ID在語言切換後保持不變</li>
                    <li><strong>內容正確性</strong>：所有題目和選項的內容都正確切換</li>
                    <li><strong>功能正常性</strong>：切換後的題目可以正常回答</li>
                    <li><strong>多次切換支持</strong>：支持在測驗過程中多次切換語言</li>
                    <li><strong>狀態一致性</strong>：測驗進度和狀態在語言切換後保持一致</li>
                </ul>
                
                <h3>🎯 測試重點</h3>
                <ul>
                    <li><strong>持續性</strong>：確認語言切換效果在整個測驗中持續有效</li>
                    <li><strong>完整性</strong>：確認所有題目都正確切換語言</li>
                    <li><strong>穩定性</strong>：確認多次切換不會導致問題</li>
                    <li><strong>正確性</strong>：確認切換後的內容正確且功能正常</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        function goToQuiz() {
            window.location.href = 'exam_quiz.html';
        }

        function testPersistentSwitch() {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>測試狀態：</strong>🔄 持續語言切換測試：請開始測驗，切換語言後確認所有後續題目都使用新語言版本，不只是當前題目';
            status.className = 'status';
        }

        function testReverseSwitch() {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>測試狀態：</strong>↩️ 反向切換測試：請在測驗進行中切換語言，確認當前題目和所有後續題目都正確切換語言';
            status.className = 'status';
        }

        function testMultipleSwitch() {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>測試狀態：</strong>🔄 多次切換測試：請在測驗進行中多次切換語言，確認每次切換後所有題目都正確使用新語言版本';
            status.className = 'status';
        }

        // 頁面載入時顯示狀態
        document.addEventListener('DOMContentLoaded', function() {
            const status = document.getElementById('status');
            status.innerHTML = '<strong>測試狀態：</strong>✅ 持續語言切換測試頁面已載入，請按照測試步驟進行測試';
            status.className = 'status';
        });
    </script>
</body>
</html>
