<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯• handleExamFinish å‡½æ•°</title>
</head>
<body>
    <h1>è°ƒè¯• handleExamFinish å‡½æ•°</h1>
    <button onclick="testFunction()">æµ‹è¯•å‡½æ•°</button>
    <div id="debug-info"></div>

    <!-- 1. å…ˆè¼‰å…¥ firebase.js -->
    <script type="module" src="./js/firebase.js"></script>
    
    <!-- 2. è½½å…¥ handleExamFinish å‡½æ•° -->
    <script type="module">
      import { auth, db } from './js/firebase.js';
      import {
        collection, addDoc, serverTimestamp, setDoc, doc, getDocs, query, orderBy, documentId, limit
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
      import {
        onAuthStateChanged, signInAnonymously as fbSignInAnonymously
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      console.log("ğŸ” å¼€å§‹åŠ è½½ handleExamFinish å‡½æ•°...");

      function ensureFirebase() {
        return {
          app: window.__FB__.app,
          db: db,
          auth: auth,
        };
      }

      async function ensureSignedIn(auth) {
        if (auth.currentUser) return auth.currentUser;
        try {
          const cred = await fbSignInAnonymously(auth);
          console.log("ğŸ” å·²åŒ¿åç™»å…¥ï¼š", cred.user.uid);
          return cred.user;
        } catch (e) {
          console.error("âŒ åŒ¿åç™»å…¥å¤±æ•—ï¼š", e.code, e.message);
          throw e;
        }
      }

      function resolveUserName() {
        try {
          const p = JSON.parse(localStorage.getItem("pbls_user_profile") || "null");
          if (p?.name) return p.name;
        } catch {}
        return (window.currentUserName && String(window.currentUserName)) || "æœªå‘½åä½¿ç”¨è€…";
      }

      async function getNextScoreId(db) {
        try {
          const q = query(collection(db, "scores"), orderBy(documentId(), "desc"), limit(1));
          const snap = await getDocs(q);
          if (snap.empty) return 1;
          const lastId = snap.docs[0].id;
          const match = lastId.match(/^scores(\d+)$/);
          const maxId = match ? parseInt(match[1]) : 0;
          const nextId = maxId + 1;
          console.log("ğŸ“Š ç²å–çš„ä¸‹ä¸€å€‹åºè™Ÿ:", nextId);
          return nextId;
        } catch (error) {
          console.error("âŒ ç²å–åºè™Ÿå¤±æ•—:", error);
          return 1;
        }
      }

      // å®šä¹‰ handleExamFinish å‡½æ•°
      async function handleExamFinish(finalScore, timeSpentMs, startedAtMs, correctCount, questionCount) {
        console.log("ğŸ¯ handleExamFinish å‡½æ•°è¢«è°ƒç”¨ï¼");
        console.log("å‚æ•°:", { finalScore, timeSpentMs, startedAtMs, correctCount, questionCount });
        
        const { db, auth } = ensureFirebase();
        try {
          const user = await ensureSignedIn(auth);
          const userName = resolveUserName();
          console.log("ğŸ‘¤ ä½¿ç”¨è€…ï¼š", userName, "ï½œåˆ†æ•¸ï¼š", finalScore);
          console.log("ğŸ” ç”¨æˆ¶ UIDï¼š", user.uid);

          const nextScoreId = await getNextScoreId(db);
          console.log("ğŸ“Š ä¸‹ä¸€å€‹åºè™Ÿï¼š", nextScoreId);

          const data = { 
            uid: user.uid,
            userName,
            score: Math.round(Number(finalScore)),
            timeSpentMs: Math.max(0, Math.floor(timeSpentMs || 0)),
            startedAt: startedAtMs ? Math.floor(startedAtMs) : null,
            correctCount: Number.isInteger(correctCount) ? correctCount : null,
            questionCount: Number.isInteger(questionCount) ? questionCount : null,
            examType: "ç­†è©¦æ¸¬é©—",
            submittedAt: serverTimestamp(),
            clientInfo: {
              userAgent: navigator.userAgent,
              timestamp: Date.now()
            }
          };

          console.log("ğŸ“Š æº–å‚™å¯«å…¥è³‡æ–™ï¼š", data);

          const docRef = doc(db, "scores", `scores${nextScoreId}`);
          await setDoc(docRef, data);

          console.log(`âœ… æˆç¸¾å·²æˆåŠŸä¿å­˜åˆ° scores é›†åˆï¼Œæ–‡ä»¶ ID: scores${nextScoreId}`);
          return true;
        } catch (error) {
          console.error("âŒ ä¿å­˜æˆç¸¾å¤±æ•—ï¼š", error);
          return false;
        }
      }

      // ç«‹å³æš´éœ²åˆ° window
      window.handleExamFinish = handleExamFinish;
      console.log("âœ… handleExamFinish å‡½æ•¸å·²æš´éœ²åˆ° window å°è±¡");
      console.log("ğŸ” å‡½æ•¸é¡å‹:", typeof window.handleExamFinish);
      
      // æµ‹è¯•å‡½æ•°æ˜¯å¦å¯ç”¨
      if (typeof window.handleExamFinish === 'function') {
        console.log("âœ… handleExamFinish å‡½æ•¸æ¸¬è©¦æˆåŠŸ");
      } else {
        console.error("âŒ handleExamFinish å‡½æ•¸æ¸¬è©¦å¤±æ•—");
      }

      // è§‚å¯Ÿç™»å½•çŠ¶æ€
      const { auth } = ensureFirebase();
      onAuthStateChanged(auth, (u) => {
        console.log("ğŸ” auth ç‹€æ…‹ï¼š", u ? (u.isAnonymous ? "åŒ¿å-" + u.uid : (u.email || u.uid)) : "æœªç™»å…¥");
      });
    </script>

    <script>
        function testFunction() {
            const debugDiv = document.getElementById('debug-info');
            
            console.log("ğŸ§ª å¼€å§‹æµ‹è¯•...");
            debugDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';
            
            if (typeof window.handleExamFinish === 'function') {
                debugDiv.innerHTML = '<p style="color: green;">âœ… handleExamFinish å‡½æ•°å­˜åœ¨ï¼</p>';
                
                // æµ‹è¯•è°ƒç”¨
                window.handleExamFinish(85, 12000, Date.now() - 12000, 17, 20)
                    .then(success => {
                        if (success) {
                            debugDiv.innerHTML += '<p style="color: green;">âœ… æµ‹è¯•æˆç»©ä¿å­˜æˆåŠŸï¼</p>';
                        } else {
                            debugDiv.innerHTML += '<p style="color: red;">âŒ æµ‹è¯•æˆç»©ä¿å­˜å¤±è´¥ï¼</p>';
                        }
                    })
                    .catch(error => {
                        debugDiv.innerHTML += '<p style="color: red;">âŒ æµ‹è¯•æ—¶å‘ç”Ÿé”™è¯¯ï¼š' + error.message + '</p>';
                    });
            } else {
                debugDiv.innerHTML = '<p style="color: red;">âŒ handleExamFinish å‡½æ•°ä¸å­˜åœ¨ï¼</p>';
                debugDiv.innerHTML += '<p>å‡½æ•°ç±»å‹: ' + typeof window.handleExamFinish + '</p>';
                debugDiv.innerHTML += '<p>window ä¸Šçš„å‡½æ•°: ' + Object.keys(window).filter(k => k.includes('handle')).join(', ') + '</p>';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log("ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å‡½æ•°...");
            setTimeout(() => {
                console.log("ğŸ” å»¶è¿Ÿæ£€æŸ¥ window.handleExamFinish:", typeof window.handleExamFinish);
                if (typeof window.handleExamFinish === 'function') {
                    console.log("âœ… é¡µé¢åŠ è½½åå‡½æ•°å­˜åœ¨");
                } else {
                    console.error("âŒ é¡µé¢åŠ è½½åå‡½æ•°ä¸å­˜åœ¨");
                }
            }, 1000);
        });
    </script>
</body>
</html>
