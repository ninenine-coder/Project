<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VR 360 播放</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <style>html,body{margin:0;height:100%;background:#000}</style>
</head>
<body>
  <!-- 實際播放用的 <video>，先不顯示 -->
  <video id="vid" playsinline webkit-playsinline preload="auto" crossOrigin="anonymous" style="display:none"></video>

  <a-scene
    renderer="antialias:false; precision:mediump; colorManagement:true; powerPreference:high-performance; sortObjects:false"
    vr-mode-ui="enabled:true">

    <!-- 360 球幕 -->
    <a-videosphere src="#vid" rotation="0 180 0"></a-videosphere>

    <!-- 載入轉圈 + 文字 -->
    <a-entity id="loader" position="0 1.6 -2">
      <a-torus-knot radius="0.25" radius-tubular="0.02" color="#7e57c2"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 1500; easing: linear"></a-torus-knot>
      <a-entity position="0 -0.5 0"
        text="value: 正在載入影片…; align: center; color: #fff; width: 2"></a-entity>
    </a-entity>

    <!-- 播放按鈕（需手把或游標點擊） -->
    <a-entity id="playUI" visible="false" position="0 1.6 -2">
      <a-plane id="playBtn" width="0.8" height="0.3" color="#26a69a"
               event-set__enter="_event:mouseenter; color:#2bbbad"
               event-set__leave="_event:mouseleave; color:#26a69a">
        <a-entity position="0 0 0.01"
          text="value: ▶ 播放; align: center; color:#fff; width: 1.2"></a-entity>
      </a-plane>
      <a-entity position="0 -0.5 0" text="value: 用手把雷射點擊開始; align:center; color:#ccc; width:2"></a-entity>
    </a-entity>

    <!-- 右手雷射（Vive/Index/通用 WebXR） -->
    <a-entity laser-controls="hand: right" raycaster="objects: #playBtn"></a-entity>
    <!-- 注視游標（以防沒有手把） -->
    <a-entity camera look-controls wasd-controls>
      <a-cursor raycaster="objects: #playBtn"></a-cursor>
    </a-entity>
  </a-scene>

  <script>
  const video = document.getElementById('vid');
  const loader = document.getElementById('loader');
  const playUI = document.getElementById('playUI');
  const playBtn = document.getElementById('playBtn');
  const SRC = './assets/360/hls-master/index.m3u8'; // ← 改成你的 master.m3u8

  // 1) 偵測是否有 VR 裝置（可選，用來提示）
  (async () => {
    if (!('xr' in navigator)) return;
    try {
      const ok = await navigator.xr.isSessionSupported('immersive-vr');
      console.log('VR 裝置支援:', ok);
    } catch {}
  })();

  // 2) 掛 HLS 並監聽載入進度，先顯示轉圈
  function attachHLS(){
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = SRC;         // Safari
    } else if (window.Hls?.isSupported()) {
      const hls = new Hls({
        lowLatencyMode:false, capLevelToPlayerSize:true,
        maxBufferLength:15, backBufferLength:15, enableWorker:true
      });
      hls.loadSource(SRC);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=> console.log('HLS manifest 解析完成'));
      hls.on(Hls.Events.LEVEL_LOADED, ()=> console.log('HLS level 已載入'));
    } else {
      alert('此瀏覽器不支援 HLS 播放');
    }
  }
  attachHLS();

  // 3) 當影片可播放時，關閉「載入中」，顯示「播放按鈕」
  function showPlay(){
    loader.setAttribute('visible', 'false');
    playUI.setAttribute('visible', 'true');
  }
  video.addEventListener('canplay', showPlay);
  video.addEventListener('canplaythrough', showPlay);

  // 4) 讓「手把雷射點擊」或「注視游標點擊」都能觸發播放
  function tryPlay(){
    playUI.setAttribute('visible','false');
    video.muted = false;                   // 解除靜音
    video.play().catch(err=>{
      console.warn('自動播放被擋，請再點一次', err);
      playUI.setAttribute('visible','true');
    });
  }
  playBtn.addEventListener('click', tryPlay);

  // 也支援手把 trigger（有些瀏覽器不會派 click）
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('controllerconnected', (e) => {
    const el = e.detail && e.detail.controller;
    // Vive/通用：聽 triggerdown
    sceneEl.querySelectorAll('[laser-controls]').forEach(ctrl=>{
      ctrl.addEventListener('triggerdown', () => {
        // 若游標正指向播放鍵，也算點擊
        const intersects = ctrl.components.raycaster?.intersections || [];
        if (intersects.some(i => i.el === playBtn)) tryPlay();
      });
    });
  });

  // 5) 進 VR 時自動聚焦頁面（避免政策擋播放）
  document.addEventListener('enter-vr', ()=> window.focus());

  </script>
</body>
</html>
