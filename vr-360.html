<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VR 360 æ’­æ”¾</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    /* æ¡Œé¢æç¤º */
    #desktopHint{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:12px 24px;
      border-radius:8px;
      font:14px/1.5 system-ui;
      text-align:center;
      pointer-events:none;
      opacity:0;
      transition:opacity 0.3s;
      z-index:100;
    }
    #desktopHint.show{opacity:1}
  </style>
</head>
<body>
  <!-- å¯¦éš›æ’­æ”¾ç”¨çš„ <video>ï¼Œå…ˆä¸é¡¯ç¤º -->
  <video id="vid" playsinline webkit-playsinline preload="auto" crossOrigin="anonymous" style="display:none"></video>

  <!-- æ¡Œé¢æ¨¡å¼æç¤º -->
  <div id="desktopHint">
    ğŸ–±ï¸ ç”¨æ»‘é¼ æ‹–æ›³ç’°é¡§å››å‘¨ | ğŸ“± è½‰å‹•è£ç½®æŸ¥çœ‹ 360Â° | ğŸ® æœ‰ VR é ­ç›”ï¼Ÿé»å³ä¸‹è§’é€²å…¥
  </div>

  <!-- æ¡Œé¢æ¨¡å¼ï¼šå…¨è¢å¹•é»æ“Šå•Ÿå‹•ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰ -->
  <div id="clickToStart" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
       background:rgba(0,0,0,0.8); z-index:200; cursor:pointer; 
       display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <div style="background:#9c27b0; color:#fff; padding:20px 40px; border-radius:12px; 
         font:24px/1.5 system-ui; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.5);">
      â–¶
    </div>
    <div style="color:#ccc; margin-top:20px; font:16px system-ui; text-align:center;">
      é»æ“Šä»»æ„è™•é–‹å§‹æ’­æ”¾<br>
      æ’­æ”¾å¾Œå¯ç”¨æ»‘é¼ æ‹–æ›³ç’°é¡§ 360Â°
    </div>
  </div>

  <!-- æ¡Œé¢æ¨¡å¼ï¼šé‡æ’­æŒ‰éˆ• -->
  <div id="clickToReplay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
       background:rgba(0,0,0,0.7); z-index:200; cursor:pointer; 
       display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <div style="font-size:80px; margin-bottom:8px;">
      ğŸ”„
    </div>
    <div style="color:#ccc; font:16px system-ui;">
      é‡æ–°è§€çœ‹ 360Â° å½±ç‰‡
    </div>
  </div>


  <a-scene
    renderer="antialias:false; precision:mediump; colorManagement:true; powerPreference:high-performance; sortObjects:false"
    vr-mode-ui="enabled:true"
    style="height:60vh; position:relative; margin-bottom:20px;">

    <!-- 360 çƒå¹• -->
    <a-videosphere src="#vid" rotation="0 250 0"></a-videosphere>

    <!-- è¼‰å…¥è½‰åœˆ + æ–‡å­— -->
    <a-entity id="loader" position="0 1.6 -2">
      <a-torus-knot radius="0.25" radius-tubular="0.02" color="#7e57c2"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 1500; easing: linear"></a-torus-knot>
      <a-entity position="0 -0.5 0"
        text="value: æ­£åœ¨è¼‰å…¥å½±ç‰‡â€¦; align: center; color: #fff; width: 2"></a-entity>
    </a-entity>

    <!-- æ’­æ”¾æŒ‰éˆ•ï¼ˆVR æ¨¡å¼ç”¨æ‰‹æŠŠï¼Œæ¡Œé¢ç”¨æ»‘é¼ ï¼‰ -->
    <a-entity id="playUI" visible="false" position="0 1.6 -2">
      <a-plane id="playBtn" width="1.2" height="0.4" color="#26a69a"
               event-set__enter="_event:mouseenter; color:#2bbbad"
               event-set__leave="_event:mouseleave; color:#26a69a">
        <a-entity position="0 0 0.01"
          text="value: â–¶ é»æ“Šæ’­æ”¾; align: center; color:#fff; width: 1.8"></a-entity>
      </a-plane>
      <a-entity id="playHint" position="0 -0.5 0" 
        text="value: æ¡Œé¢ï¼šé»æ“Šæ’­æ”¾ | VRï¼šç”¨æ‰‹æŠŠé›·å°„é»æ“Š; align:center; color:#ccc; width:2.5"></a-entity>
    </a-entity>


    <!-- å³æ‰‹é›·å°„ï¼ˆVive/Index/é€šç”¨ WebXRï¼‰ -->
    <a-entity laser-controls="hand: right" raycaster="objects: #playBtn"></a-entity>
    
    <!-- æ”å½±æ©Ÿ + æ§åˆ¶ï¼ˆæ¡Œé¢æ»‘é¼ æ‹–æ›³ã€è¡Œå‹•é™€èºå„€ã€VR é ­ç›”è¿½è¹¤ï¼‰ -->
    <!-- æ”å½±æ©Ÿä¿æŒæ­£å‰æ–¹ï¼Œçƒå¹•å·²å›ºå®šæ—‹è½‰åˆ°æ­£ç¢ºè§’åº¦ -->
    <a-entity camera look-controls="touchEnabled:true; mouseEnabled:true; pointerLockEnabled:false" 
              wasd-controls="enabled:false"
              position="0 1.6 0" 
              rotation="0 0 0">
      <!-- æ¡Œé¢/è¡Œå‹•æ¨¡å¼ï¼šæ³¨è¦–æ¸¸æ¨™ -->
      <a-cursor id="desktopCursor" raycaster="objects: #playBtn" 
                fuse="false" 
                color="#4CAF50"></a-cursor>
    </a-entity>
  </a-scene>

  <!-- è¨è«–å€ -->
  <section id="discussion" style="max-width:1000px;margin:0 auto 40px;padding:20px;color:#333;font-family:system-ui;background:#f8f9fa;border-radius:12px;position:relative;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
    <h2 style="margin:8px 0 16px;color:#2c3e50;font-size:24px;font-weight:600;">è¨è«–å€</h2>

    <!-- ç™¼æ–‡ -->
    <div style="background:#fff;padding:16px;border-radius:10px;margin-bottom:16px;border:1px solid #e9ecef;">
      <textarea id="newComment" rows="3" placeholder="ç•™ä¸‹æƒ³æ³•æˆ–æå•ï¼ˆShift+Enter æ›è¡Œï¼ŒEnter é€å‡ºï¼‰"
        style="width:100%;background:#fff;color:#333;border:1px solid #ddd;border-radius:8px;padding:12px;font-size:14px;resize:vertical;"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="postBtn" style="padding:10px 20px;border:1px solid #26a69a;color:#26a69a;background:transparent;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.3s;">
          ç™¼ä½ˆ
        </button>
      </div>
      <div id="whoami" style="font-size:12px;color:#6c757d;margin-top:8px;"></div>
    </div>

    <!-- ç•™è¨€åˆ—è¡¨ -->
    <div id="commentList" style="display:flex;flex-direction:column;gap:16px;background:#fff;padding:16px;border-radius:10px;border:1px solid #e9ecef;"></div>
  </section>

  <script>
    const video = document.getElementById('vid');
  const loader = document.getElementById('loader');
  const playUI = document.getElementById('playUI');
  const playBtn = document.getElementById('playBtn');
  const playHint = document.getElementById('playHint');
  const desktopHint = document.getElementById('desktopHint');
  const desktopCursor = document.getElementById('desktopCursor');
  const clickToStart = document.getElementById('clickToStart');
  const clickToReplay = document.getElementById('clickToReplay');
  const SRC = './assets/360/hls-master/index.m3u8';

  let isVRMode = false;
  let videoReady = false;
  let mouseDownPos = null;
  let isDragging = false;
  let isPracticeMode = false; // æª¢æŸ¥æ˜¯å¦ç‚ºç·´ç¿’æ¨¡å¼

  // 0) æª¢æŸ¥URLåƒæ•¸ï¼Œå¦‚æœå¾ç·´ç¿’æ¨¡æ“¬é€²å…¥å‰‡ç¦ç”¨é‡æ’­åŠŸèƒ½
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('mode') === 'practice') {
    isPracticeMode = true;
    console.log('ç·´ç¿’æ¨¡å¼ï¼šç¦ç”¨é‡æ’­åŠŸèƒ½');
    
    // å®Œå…¨ç§»é™¤é‡æ’­æŒ‰éˆ•å…ƒç´ 
    setTimeout(() => {
      const clickToReplay = document.getElementById('clickToReplay');
      if (clickToReplay) {
        clickToReplay.remove();
      }
    }, 100);
  }

  // 1) åµæ¸¬æ˜¯å¦æœ‰ VR è£ç½®
  (async () => {
    if (!('xr' in navigator)) return;
    try {
      const ok = await navigator.xr.isSessionSupported('immersive-vr');
      console.log('VR è£ç½®æ”¯æ´:', ok);
      if (!ok) {
        // æ²’æœ‰ VR è£ç½®ï¼Œé¡¯ç¤ºæ¡Œé¢æç¤º
        setTimeout(() => desktopHint.classList.add('show'), 1000);
        setTimeout(() => desktopHint.classList.remove('show'), 8000);
      }
    } catch {
      // é¡¯ç¤ºæ¡Œé¢æç¤º
      setTimeout(() => desktopHint.classList.add('show'), 1000);
      setTimeout(() => desktopHint.classList.remove('show'), 8000);
    }
  })();

  // 2) æ› HLS ä¸¦ç›£è½è¼‰å…¥é€²åº¦
  function attachHLS(){
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = SRC;
    } else if (window.Hls?.isSupported()) {
      const hls = new Hls({
        lowLatencyMode:false, 
        capLevelToPlayerSize:true,
        maxBufferLength:15, 
        backBufferLength:15, 
        enableWorker:true,
        startLevel: -1  // è‡ªå‹•é¸æ“‡ç•«è³ª
      });
      hls.loadSource(SRC);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=> console.log('HLS manifest è§£æå®Œæˆ'));
      hls.on(Hls.Events.LEVEL_SWITCHED, (e, data)=> {
        console.log('åˆ‡æ›åˆ°ç•«è³ª:', hls.levels[data.level]?.height + 'p');
      });
    } else {
      alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ HLS æ’­æ”¾');
    }
  }
  attachHLS();

  // 3) å½±ç‰‡è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•
  function showPlay(){
    if (videoReady) return; // é¿å…é‡è¤‡è§¸ç™¼
    videoReady = true;
    
    loader.setAttribute('visible', 'false');
    
    // æ¡Œé¢æ¨¡å¼ï¼šé¡¯ç¤ºå…¨è¢å¹•é»æ“Šæç¤ºï¼ˆæ›´å®¹æ˜“é»åˆ°ï¼‰
    if (!isVRMode) {
      clickToStart.style.display = 'flex';
      desktopHint.classList.remove('show');
    } else {
      // VR æ¨¡å¼ï¼šé¡¯ç¤º 3D æ’­æ”¾æŒ‰éˆ•
      playUI.setAttribute('visible', 'true');
    }
  }
  video.addEventListener('canplay', showPlay);
  video.addEventListener('canplaythrough', showPlay);

  // 4) æ’­æ”¾é‚è¼¯ï¼ˆæ”¯æ´æ¡Œé¢é»æ“Šå’Œ VR æ‰‹æŠŠï¼‰
  function tryPlay(){
    playUI.setAttribute('visible','false');
    clickToStart.style.display = 'none';
      video.muted = false;
    video.play().catch(err=>{
      console.warn('è‡ªå‹•æ’­æ”¾è¢«æ“‹ï¼Œè«‹å†é»ä¸€æ¬¡', err);
      if (!isVRMode) {
        clickToStart.style.display = 'flex';
      } else {
        playUI.setAttribute('visible','true');
      }
    });
    
    // éš±è—æ‰€æœ‰æç¤º
    desktopHint.classList.remove('show');
  }
  
  // VR æ¨¡å¼ï¼šA-Frame æŒ‰éˆ•é»æ“Š
  playBtn.addEventListener('click', tryPlay);
  
  // æ¡Œé¢æ¨¡å¼ï¼šå…¨è¢å¹•é»æ“Š
  clickToStart.addEventListener('click', tryPlay);

  // 1) çµ±ä¸€çš„ã€Œé‡ç½® UIã€å‡½å¼
  function resetUI(showLoader = true) {
    // ç‹€æ…‹æ——æ¨™
    isVRMode = false;
    videoReady = false;

    // è¦–è¨Š
    try { video.pause(); } catch {}
    try { video.currentTime = 0; } catch {}

    // UI å…ƒä»¶
    playUI.setAttribute('visible', 'false');   // éš±è— 3D æ’­æ”¾æŒ‰éˆ•
    clickToStart.style.display = 'none';
    clickToReplay.style.display = 'none';
    desktopHint.classList.remove('show');

    if (loader) loader.setAttribute('visible', showLoader ? 'true' : 'false');
  }

  // é‡æ’­åŠŸèƒ½
  function showReplay() {
    // åªæœ‰åœ¨éç·´ç¿’æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºé‡æ’­æŒ‰éˆ•
    if (video.ended && video.currentTime > 0 && !isPracticeMode) {
      if (!isVRMode) {
        clickToReplay.style.display = 'flex';
      }
    }
  }

  function doReplay() {
    // åªæœ‰åœ¨éç·´ç¿’æ¨¡å¼ä¸‹æ‰åŸ·è¡Œé‡æ’­
    if (!isPracticeMode) {
      // é»æ“Šé‡æ’­å¾Œå›åˆ°åˆå§‹ç‹€æ…‹
      clickToReplay.style.display = 'none';
      video.currentTime = 0; // é‡è¨­åˆ°é–‹é ­
      video.pause(); // æš«åœå½±ç‰‡ï¼Œä¸è‡ªå‹•æ’­æ”¾
      
      // é‡è¨­æ”å½±æ©Ÿåˆ°åˆå§‹è¦–è§’
      const camera = document.querySelector('[camera]');
      if (camera) {
        camera.setAttribute('position', '0 1.6 0');
        camera.setAttribute('rotation', '0 0 0');
      }
      
      // é¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•ï¼ˆå›åˆ°åˆå§‹ç‹€æ…‹ï¼‰
      if (!isVRMode) {
        clickToStart.style.display = 'flex';
      }
    }
  }

  // 2) å›åˆ°æ­¤é ï¼ˆbfcache æ¢å¾©ï¼‰æ™‚é‡ç½®
  // ä½¿ç”¨è€…å¾ç·´ç¿’å°ˆå€è¿”å›ï¼ˆbfcache é‚„åŸï¼‰ï¼Œå¼·åˆ¶é‡ç½®ç‹€æ…‹
  window.addEventListener('pageshow', (e) => {
    // e.persisted ç‚º true ä»£è¡¨å¾ bfcache å›ä¾†
    resetUI(true);
  });

  // 3) é›¢é–‹æ­¤é æ™‚å…ˆæš«åœ
  window.addEventListener('pagehide', () => {
    try { video.pause(); } catch {}
  });
  window.addEventListener('beforeunload', () => {
    try { video.pause(); } catch {}
  });

  // å½±ç‰‡æ’­æ”¾çµæŸæ™‚é¡¯ç¤ºé‡æ’­æŒ‰éˆ•
  video.addEventListener('ended', showReplay);

  // æ¡Œé¢æ¨¡å¼ï¼šé‡æ’­æŒ‰éˆ•é»æ“Šï¼ˆåªæœ‰åœ¨éç·´ç¿’æ¨¡å¼ä¸‹æ‰ç¶å®šï¼‰
  if (!isPracticeMode) {
    clickToReplay.addEventListener('click', doReplay);
  }


  // 5) VR æ‰‹æŠŠæ”¯æ´
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('controllerconnected', (e) => {
    console.log('VR æ§åˆ¶å™¨å·²é€£æ¥');
    sceneEl.querySelectorAll('[laser-controls]').forEach(ctrl=>{
      ctrl.addEventListener('triggerdown', () => {
        const intersects = ctrl.components.raycaster?.intersections || [];
        if (intersects.some(i => i.el === playBtn)) tryPlay();
      });
    });
  });

  // 6) é€²å…¥/é›¢é–‹ VR æ¨¡å¼
  sceneEl.addEventListener('enter-vr', ()=> {
    isVRMode = true;
    clickToStart.style.display = 'none'; // éš±è—æ¡Œé¢é»æ“Šå€
    desktopHint.classList.remove('show');
    desktopCursor.setAttribute('visible', 'false');
    playHint.setAttribute('text', 'value: ç”¨æ‰‹æŠŠé›·å°„é»æ“Šé–‹å§‹; align:center; color:#ccc; width:2');
    
    // å¦‚æœå½±ç‰‡å·²æº–å‚™å¥½ï¼Œé¡¯ç¤º VR æ’­æ”¾æŒ‰éˆ•
    if (videoReady && !video.paused === false) {
      playUI.setAttribute('visible', 'true');
    }
    window.focus();
  });

  sceneEl.addEventListener('exit-vr', ()=> {
    // é€€å‡º VR å°±é‡ç½®ï¼ˆé¡¯ç¤º loaderã€æ”¶æŒ‰éˆ•ï¼‰
    resetUI(true);
    desktopCursor.setAttribute('visible', 'true');
    playHint.setAttribute('text', 'value: æ¡Œé¢ï¼šé»æ“Šæ’­æ”¾ | VRï¼šç”¨æ‰‹æŠŠé›·å°„é»æ“Š; align:center; color:#ccc; width:2.5');
  });

  // 8) é»æ“Šæš«åœ/æ’­æ”¾åŠŸèƒ½ï¼ˆå€åˆ†é»æ“Šå’Œæ‹–æ›³ï¼‰
  // ç¢ºä¿åœ¨ A-Frame è¼‰å…¥å®Œæˆå¾Œç¶å®šäº‹ä»¶
  sceneEl.addEventListener('loaded', () => {
    const sceneCanvas = sceneEl.canvas;
    if (!sceneCanvas) {
      console.warn('ç„¡æ³•æ‰¾åˆ° scene canvas');
      return;
    }
    
    sceneCanvas.addEventListener('mousedown', (e) => {
      mouseDownPos = { x: e.clientX, y: e.clientY };
      isDragging = false;
      console.log('æ»‘é¼ æŒ‰ä¸‹', mouseDownPos);
    });

    sceneCanvas.addEventListener('mousemove', (e) => {
      if (mouseDownPos) {
        const moved = Math.abs(e.clientX - mouseDownPos.x) + Math.abs(e.clientY - mouseDownPos.y);
        if (moved > 5) {  // ç§»å‹•è¶…é 5px è¦–ç‚ºæ‹–æ›³
          isDragging = true;
        }
      }
    });

    sceneCanvas.addEventListener('mouseup', (e) => {
      console.log('æ»‘é¼ æ”¾é–‹', { mouseDownPos, isDragging, videoReady: video.readyState >= 2, isVRMode, videoPaused: video.paused });
      if (mouseDownPos && !isDragging && video.readyState >= 2 && !isVRMode) {
        // æ˜¯é»æ“Šä¸”ä¸æ˜¯æ‹–æ›³ï¼Œä¸”å½±ç‰‡å·²è¼‰å…¥ï¼Œä¸”ä¸åœ¨ VR æ¨¡å¼
        console.log('åŸ·è¡Œé»æ“Šå‹•ä½œï¼Œå½±ç‰‡ç‹€æ…‹:', video.paused ? 'å·²æš«åœ' : 'æ’­æ”¾ä¸­');
        if (video.paused) {
          video.play().then(() => {
            console.log('é»æ“Šæ’­æ”¾æˆåŠŸ');
          }).catch(err => {
            console.warn('æ’­æ”¾å¤±æ•—', err);
          });
        } else {
          video.pause();
          console.log('é»æ“Šæš«åœ');
        }
      }
      mouseDownPos = null;
      isDragging = false;
    });
  });

  // è§¸æ§è£ç½®ï¼šé»æ“Šæš«åœ/æ’­æ”¾ï¼ˆä¹Ÿåœ¨ A-Frame è¼‰å…¥å¾Œç¶å®šï¼‰
  sceneEl.addEventListener('loaded', () => {
    const sceneCanvas = sceneEl.canvas;
    if (!sceneCanvas) {
      console.warn('ç„¡æ³•æ‰¾åˆ° scene canvas (è§¸æ§)');
      return;
    }
    
    sceneCanvas.addEventListener('touchstart', (e) => {
      if (e.touches.length === 1) {
        mouseDownPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        isDragging = false;
      }
    });

    sceneCanvas.addEventListener('touchmove', (e) => {
      if (mouseDownPos && e.touches.length === 1) {
        const moved = Math.abs(e.touches[0].clientX - mouseDownPos.x) + Math.abs(e.touches[0].clientY - mouseDownPos.y);
        if (moved > 10) {  // è§¸æ§ç§»å‹•é–¾å€¼ç¨å¤§
          isDragging = true;
        }
      }
    });

    sceneCanvas.addEventListener('touchend', (e) => {
      if (mouseDownPos && !isDragging && video.readyState >= 2 && !isVRMode) {
        if (video.paused) {
          video.play().then(() => {
            console.log('è§¸æ§æ’­æ”¾æˆåŠŸ');
          }).catch(err => {
            console.warn('è§¸æ§æ’­æ”¾å¤±æ•—', err);
          });
        } else {
          video.pause();
          console.log('è§¸æ§æš«åœ');
        }
      }
      mouseDownPos = null;
      isDragging = false;
    });
  });


  // 4) é é¢å¯è¦‹æ€§æª¢æ¸¬ - é›¢é–‹é é¢æ™‚éš±è—é‡æ’­æŒ‰éˆ•
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      if (!isPracticeMode) {
        clickToReplay.style.display = 'none';
      }
      // â˜… æ–°å¢ï¼šé›¢é–‹ç•«é¢å°±æŠŠ 3D æ’­æ”¾éµæ”¶æ‰
      playUI.setAttribute('visible', 'false');
    } else if (document.visibilityState === 'visible') {
      if (!isPracticeMode) {
        clickToReplay.style.display = 'none';
      }
      video.currentTime = 0;
      video.pause();
      
      // é‡è¨­æ”å½±æ©Ÿåˆ°åˆå§‹è¦–è§’
      const camera = document.querySelector('[camera]');
      if (camera) {
        camera.setAttribute('position', '0 1.6 0');
        camera.setAttribute('rotation', '0 0 0');
      }
      
      // â˜… æ–°å¢ï¼šå›åˆ°ç•«é¢æ™‚ä¹ŸæŠŠ 3D æ’­æ”¾éµæ”¶æ‰ & é¡¯ç¤º loaderï¼Œå¾… canplay å†å‡ºç¾ UI
      playUI.setAttribute('visible', 'false');
      loader.setAttribute('visible', 'true');
      videoReady = false;
      
      if (!isVRMode) {
        clickToStart.style.display = 'flex';
      }
    }
  });

  // 8) è¡Œå‹•è£ç½®ï¼šæ›´æ–°æç¤ºæ–‡å­—
  if ('ontouchstart' in window) {
    // ç­‰å½±ç‰‡è¼‰å…¥å¾Œï¼Œæœƒé¡¯ç¤ºå…¨è¢å¹•é»æ“Šå€åŸŸ
    const textDiv = clickToStart.querySelector('div:last-child');
    if (textDiv) {
      textDiv.innerHTML = 'é»æ“Šä»»æ„è™•é–‹å§‹æ’­æ”¾<br>æ’­æ”¾å¾Œå¯è½‰å‹•è£ç½®ç’°é¡§ 360Â°';
    }
  }
  </script>

  <!-- è¨è«–å€ JavaScript -->
  <script type="module">
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, where, orderBy, onSnapshot, getDocs, limit, doc, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyBuWO8hFVjjTUe2tqJDrqdbeGTrp4PoT5Q",
      authDomain: "progect-115a5.firebaseapp.com",
      projectId: "progect-115a5"
    };

    // åˆå§‹åŒ– Firebase
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // å½±ç‰‡ IDï¼šå¯«æ­»æˆ–ç”¨ç¶²å€åƒæ•¸å¸¶
    const VIDEO_ID = 'lesson-360-1';

    // 1) ç¢ºä¿ç™»å…¥ï¼ˆæœªç™»å…¥å°±åŒ¿åï¼‰
    async function ensureLogin() {
      await new Promise(resolve => {
        onAuthStateChanged(auth, async u => {
          if (u) return resolve();
          await signInAnonymously(auth);
          resolve();
        });
      });
    }

    // 2) å–ä½¿ç”¨è€…é¡¯ç¤ºè³‡è¨Šï¼ˆå¾ /user/{uid}ï¼‰
    async function getUserProfile(uid) {
      try {
        const snap = await getDoc(doc(db, 'user', uid));
        const u = snap.exists() ? snap.data() : {};
        // æŒ‰ä½ çš„æ¬„ä½å‘½åèª¿æ•´ï¼ˆä¾‹ï¼šå­¸è™Ÿ/å·¥è™Ÿã€éƒ¨é–€ï¼‰
        const name = u?.å­¦å· || u?.å·¥å· || u?.name || 'æœªå‘½å';
        const dept = u?.éƒ¨é—¨ || u?.dept || u?.college || '-';
        return { authorName: name, authorDept: dept };
      } catch {
        return { authorName: 'æœªå‘½å', authorDept: '-' };
      }
    }

    // 3) æ¸²æŸ“ä¸€ç­†ç•™è¨€+å›è¦†
    const esc = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    function renderComment(msg, replies=[]) {
      const t = msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleString() : '';
      return `
        <div class="cmt" data-id="${msg.id}" style="background:#fff;border:1px solid #e9ecef;border-radius:10px;padding:16px;margin-bottom:8px;">
          <div style="font-size:12px;color:#26a69a;font-weight:600">${esc(msg.authorDept)}ï½œ${esc(msg.authorName)} <span style="color:#6c757d">ãƒ»${t}</span></div>
          <div style="white-space:pre-wrap;margin:8px 0 12px;color:#333;line-height:1.5;">${esc(msg.text)}</div>
          <div style="display:flex;gap:10px;">
            <button class="replyBtn" data-id="${msg.id}" style="font-size:12px;color:#26a69a;background:transparent;border:1px solid #26a69a;border-radius:6px;padding:6px 12px;cursor:pointer;">å›è¦†</button>
            ${msg.uid === auth.currentUser?.uid ? `<button class="delBtn" data-id="${msg.id}" style="font-size:12px;color:#dc3545;background:transparent;border:1px solid #dc3545;border-radius:6px;padding:6px 12px;cursor:pointer;">åˆªé™¤</button>` : ``}
          </div>

          <div class="replies" style="margin-left:16px;border-left:2px solid #e9ecef;padding-left:16px;margin-top:12px;">
            ${replies.map(r=>{
              const rt = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : '';
              return `
                <div class="reply" data-id="${r.id}" style="padding:12px 0;border-bottom:1px dashed #e9ecef;">
                  <div style="font-size:12px;color:#26a69a;font-weight:600">${esc(r.authorDept)}ï½œ${esc(r.authorName)} <span style="color:#6c757d">ãƒ»${rt}</span></div>
                  <div style="white-space:pre-wrap;margin-top:6px;color:#333;line-height:1.5;">${esc(r.text)}</div>
                  ${r.uid === auth.currentUser?.uid ? `<button class="delBtn" data-id="${r.id}" style="margin-top:6px;font-size:12px;color:#dc3545;background:transparent;border:1px solid #dc3545;border-radius:6px;padding:4px 8px;cursor:pointer;">åˆªé™¤</button>` : ``}
                </div>
              `;
            }).join('')}
          </div>

          <div class="replyBox" style="display:none;margin-top:12px;">
            <textarea rows="2" class="replyText" placeholder="å›è¦†å…§å®¹â€¦" style="width:100%;background:#fff;color:#333;border:1px solid #ddd;border-radius:8px;padding:10px;font-size:14px;"></textarea>
            <div style="text-align:right;margin-top:8px;">
              <button class="sendReplyBtn" data-parent="${msg.id}" style="padding:8px 16px;border:1px solid #26a69a;color:#26a69a;background:transparent;border-radius:8px;cursor:pointer;font-size:14px;">é€å‡ºå›è¦†</button>
            </div>
          </div>
        </div>
      `;
    }

    // 4) å³æ™‚ç›£è½ï¼šæ‹‰é ‚å±¤ç•™è¨€ï¼Œå†æ‹‰å›è¦†
    async function subscribeThread() {
      const box = document.getElementById('commentList');

      const qTop = query(
        collection(db, 'comments'),
        where('videoId', '==', VIDEO_ID),
        where('parentId', '==', null),
        orderBy('createdAt', 'desc'),
        limit(100)
      );

      onSnapshot(qTop, async snap => {
        const tops = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const html = [];
        for (const m of tops) {
          const qRep = query(
            collection(db, 'comments'),
            where('videoId', '==', VIDEO_ID),
            where('parentId', '==', m.id),
            orderBy('createdAt', 'asc')
          );
          const repSnap = await getDocs(qRep);
          const replies = repSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          html.push(renderComment(m, replies));
        }
        box.innerHTML = html.join('');

        // ç¶å®š UI äº‹ä»¶ï¼šå›è¦†/é€å‡º/åˆªé™¤
        box.querySelectorAll('.replyBtn').forEach(btn=>{
          btn.onclick = () => {
            const card = btn.closest('.cmt');
            const area = card.querySelector('.replyBox');
            area.style.display = (area.style.display === 'none' ? 'block' : 'none');
          };
        });
        box.querySelectorAll('.sendReplyBtn').forEach(btn=>{
          btn.onclick = async () => {
            const parentId = btn.dataset.parent;
            const card = btn.closest('.cmt');
            const text = card.querySelector('.replyText').value.trim();
            if (!text) return;
            const profile = await getUserProfile(auth.currentUser.uid);
            await addDoc(collection(db, 'comments'), {
              videoId: VIDEO_ID,
              parentId,
              text,
              uid: auth.currentUser.uid,
              authorName: profile.authorName,
              authorDept: profile.authorDept,
              createdAt: serverTimestamp()
            });
            card.querySelector('.replyText').value = '';
            card.querySelector('.replyBox').style.display = 'none';
          };
        });
        box.querySelectorAll('.delBtn').forEach(btn=>{
          btn.onclick = async () => {
            try { await deleteDoc(doc(db, 'comments', btn.dataset.id)); }
            catch (e) { alert('åˆªé™¤å¤±æ•—ï¼š' + e.message); }
          };
        });
      });
    }

    // 5) ç™¼è¡¨ç•™è¨€ï¼ˆEnter é€å‡º / Shift+Enter æ›è¡Œï¼‰
    async function setupPosting() {
      const who = document.getElementById('whoami');
      const postBtn = document.getElementById('postBtn');
      const ta = document.getElementById('newComment');

      const profile = await getUserProfile(auth.currentUser.uid);
      who.textContent = `ä»¥ ${profile.authorDept}ï½œ${profile.authorName} èº«ä»½ç™¼è¨€`;

      ta.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          postBtn.click();
        }
      });

      postBtn.onclick = async () => {
        const text = ta.value.trim();
        if (!text) return;
        await addDoc(collection(db, 'comments'), {
          videoId: VIDEO_ID,
          parentId: null,
          text,
          uid: auth.currentUser.uid,
          authorName: profile.authorName,
          authorDept: profile.authorDept,
          createdAt: serverTimestamp()
        });
        ta.value = '';
      };
    }

    // å•Ÿå‹•
    await ensureLogin();
    await setupPosting();
    await subscribeThread();
  </script>
</body>
</html>
