<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>VR 360 æ’­æ”¾</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    /* æ¡Œé¢æç¤º */
    #desktopHint{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:12px 24px;
      border-radius:8px;
      font:14px/1.5 system-ui;
      text-align:center;
      pointer-events:none;
      opacity:0;
      transition:opacity 0.3s;
      z-index:100;
    }
    #desktopHint.show{opacity:1}
  </style>
</head>
<body>
  <!-- å¯¦éš›æ’­æ”¾ç”¨çš„ <video>ï¼Œå…ˆä¸é¡¯ç¤º -->
  <video id="vid" playsinline webkit-playsinline preload="auto" crossOrigin="anonymous" style="display:none"></video>

  <!-- æ¡Œé¢æ¨¡å¼æç¤º -->
  <div id="desktopHint">
    ğŸ–±ï¸ ç”¨æ»‘é¼ æ‹–æ›³ç’°é¡§å››å‘¨ | ğŸ“± è½‰å‹•è£ç½®æŸ¥çœ‹ 360Â° | ğŸ® æœ‰ VR é ­ç›”ï¼Ÿé»å³ä¸‹è§’é€²å…¥
  </div>

  <a-scene
    renderer="antialias:false; precision:mediump; colorManagement:true; powerPreference:high-performance; sortObjects:false"
    vr-mode-ui="enabled:true">

    <!-- 360 çƒå¹• -->
    <a-videosphere src="#vid" rotation="0 180 0"></a-videosphere>

    <!-- è¼‰å…¥è½‰åœˆ + æ–‡å­— -->
    <a-entity id="loader" position="0 1.6 -2">
      <a-torus-knot radius="0.25" radius-tubular="0.02" color="#7e57c2"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 1500; easing: linear"></a-torus-knot>
      <a-entity position="0 -0.5 0"
        text="value: æ­£åœ¨è¼‰å…¥å½±ç‰‡â€¦; align: center; color: #fff; width: 2"></a-entity>
    </a-entity>

    <!-- æ’­æ”¾æŒ‰éˆ•ï¼ˆVR æ¨¡å¼ç”¨æ‰‹æŠŠï¼Œæ¡Œé¢ç”¨æ»‘é¼ ï¼‰ -->
    <a-entity id="playUI" visible="false" position="0 1.6 -2">
      <a-plane id="playBtn" width="1.2" height="0.4" color="#26a69a"
               event-set__enter="_event:mouseenter; color:#2bbbad"
               event-set__leave="_event:mouseleave; color:#26a69a">
        <a-entity position="0 0 0.01"
          text="value: â–¶ é»æ“Šæ’­æ”¾; align: center; color:#fff; width: 1.8"></a-entity>
      </a-plane>
      <a-entity id="playHint" position="0 -0.5 0" 
        text="value: æ¡Œé¢ï¼šé»æ“Šæ’­æ”¾ | VRï¼šç”¨æ‰‹æŠŠé›·å°„é»æ“Š; align:center; color:#ccc; width:2.5"></a-entity>
    </a-entity>

    <!-- å³æ‰‹é›·å°„ï¼ˆVive/Index/é€šç”¨ WebXRï¼‰ -->
    <a-entity laser-controls="hand: right" raycaster="objects: #playBtn"></a-entity>
    
    <!-- æ”å½±æ©Ÿ + æ§åˆ¶ï¼ˆæ¡Œé¢æ»‘é¼ æ‹–æ›³ã€è¡Œå‹•é™€èºå„€ã€VR é ­ç›”è¿½è¹¤ï¼‰ -->
    <a-entity camera look-controls="touchEnabled:true; mouseEnabled:true" wasd-controls>
      <!-- æ¡Œé¢/è¡Œå‹•æ¨¡å¼ï¼šæ³¨è¦–æ¸¸æ¨™ -->
      <a-cursor id="desktopCursor" raycaster="objects: #playBtn" 
                fuse="false" 
                color="#4CAF50"></a-cursor>
    </a-entity>
  </a-scene>

  <script>
  const video = document.getElementById('vid');
  const loader = document.getElementById('loader');
  const playUI = document.getElementById('playUI');
  const playBtn = document.getElementById('playBtn');
  const playHint = document.getElementById('playHint');
  const desktopHint = document.getElementById('desktopHint');
  const desktopCursor = document.getElementById('desktopCursor');
  const SRC = './assets/360/hls-master/index.m3u8';

  let isVRMode = false;

  // 1) åµæ¸¬æ˜¯å¦æœ‰ VR è£ç½®
  (async () => {
    if (!('xr' in navigator)) return;
    try {
      const ok = await navigator.xr.isSessionSupported('immersive-vr');
      console.log('VR è£ç½®æ”¯æ´:', ok);
      if (!ok) {
        // æ²’æœ‰ VR è£ç½®ï¼Œé¡¯ç¤ºæ¡Œé¢æç¤º
        setTimeout(() => desktopHint.classList.add('show'), 1000);
        setTimeout(() => desktopHint.classList.remove('show'), 8000);
      }
    } catch {
      // é¡¯ç¤ºæ¡Œé¢æç¤º
      setTimeout(() => desktopHint.classList.add('show'), 1000);
      setTimeout(() => desktopHint.classList.remove('show'), 8000);
    }
  })();

  // 2) æ› HLS ä¸¦ç›£è½è¼‰å…¥é€²åº¦
  function attachHLS(){
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = SRC;
    } else if (window.Hls?.isSupported()) {
      const hls = new Hls({
        lowLatencyMode:false, 
        capLevelToPlayerSize:true,
        maxBufferLength:15, 
        backBufferLength:15, 
        enableWorker:true,
        startLevel: -1  // è‡ªå‹•é¸æ“‡ç•«è³ª
      });
      hls.loadSource(SRC);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=> console.log('HLS manifest è§£æå®Œæˆ'));
      hls.on(Hls.Events.LEVEL_SWITCHED, (e, data)=> {
        console.log('åˆ‡æ›åˆ°ç•«è³ª:', hls.levels[data.level]?.height + 'p');
      });
    } else {
      alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ HLS æ’­æ”¾');
    }
  }
  attachHLS();

  // 3) å½±ç‰‡è¼‰å…¥å®Œæˆï¼Œé¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•
  function showPlay(){
    loader.setAttribute('visible', 'false');
    playUI.setAttribute('visible', 'true');
    
    // æ¡Œé¢æ¨¡å¼ï¼šå†æ¬¡é¡¯ç¤ºæ“ä½œæç¤º
    if (!isVRMode) {
      desktopHint.classList.add('show');
      setTimeout(() => desktopHint.classList.remove('show'), 5000);
    }
  }
  video.addEventListener('canplay', showPlay);
  video.addEventListener('canplaythrough', showPlay);

  // 4) æ’­æ”¾é‚è¼¯ï¼ˆæ”¯æ´æ¡Œé¢é»æ“Šå’Œ VR æ‰‹æŠŠï¼‰
  function tryPlay(){
    playUI.setAttribute('visible','false');
    video.muted = false;
    video.play().catch(err=>{
      console.warn('è‡ªå‹•æ’­æ”¾è¢«æ“‹ï¼Œè«‹å†é»ä¸€æ¬¡', err);
      playUI.setAttribute('visible','true');
    });
    
    // éš±è—æ¡Œé¢æç¤º
    desktopHint.classList.remove('show');
  }
  playBtn.addEventListener('click', tryPlay);

  // 5) VR æ‰‹æŠŠæ”¯æ´
  const sceneEl = document.querySelector('a-scene');
  sceneEl.addEventListener('controllerconnected', (e) => {
    console.log('VR æ§åˆ¶å™¨å·²é€£æ¥');
    sceneEl.querySelectorAll('[laser-controls]').forEach(ctrl=>{
      ctrl.addEventListener('triggerdown', () => {
        const intersects = ctrl.components.raycaster?.intersections || [];
        if (intersects.some(i => i.el === playBtn)) tryPlay();
      });
    });
  });

  // 6) é€²å…¥/é›¢é–‹ VR æ¨¡å¼
  sceneEl.addEventListener('enter-vr', ()=> {
    isVRMode = true;
    desktopHint.classList.remove('show');
    desktopCursor.setAttribute('visible', 'false'); // VR æ¨¡å¼éš±è—æ¡Œé¢æ¸¸æ¨™
    playHint.setAttribute('text', 'value: ç”¨æ‰‹æŠŠé›·å°„é»æ“Šé–‹å§‹; align:center; color:#ccc; width:2');
    window.focus();
  });

  sceneEl.addEventListener('exit-vr', ()=> {
    isVRMode = false;
    desktopCursor.setAttribute('visible', 'true'); // æ¢å¾©æ¡Œé¢æ¸¸æ¨™
    playHint.setAttribute('text', 'value: æ¡Œé¢ï¼šé»æ“Šæ’­æ”¾ | VRï¼šç”¨æ‰‹æŠŠé›·å°„é»æ“Š; align:center; color:#ccc; width:2.5');
  });

  // 7) è¡Œå‹•è£ç½®ï¼šé¡¯ç¤ºé™€èºå„€æç¤º
  if ('ontouchstart' in window) {
    setTimeout(() => {
      desktopHint.innerHTML = 'ğŸ“± è½‰å‹•è£ç½®ç’°é¡§ 360Â° | ğŸ‘† é»æ“Šæ’­æ”¾';
      desktopHint.classList.add('show');
      setTimeout(() => desktopHint.classList.remove('show'), 6000);
    }, 1500);
  }
  </script>
</body>
</html>
