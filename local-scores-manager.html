<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æˆç¸¾ç®¡ç†å·¥å…· - PBLS VRæ•™å­¸å¹³å°</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #e8d5ff 0%, #d1c4e9 50%, #b39ddb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #4a148c;
            margin-bottom: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e1bee7;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #9c27b0;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6a1b9a;
            font-size: 1.1rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: linear-gradient(135deg, #7b1fa2, #512da8);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .scores-table {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .scores-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .scores-table th,
        .scores-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1bee7;
        }
        
        .scores-table th {
            background: #f3e5f5;
            color: #4a148c;
            font-weight: 600;
        }
        
        .scores-table tr:hover {
            background: rgba(156, 39, 176, 0.1);
        }
        
        .score-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .score-excellent { background: #e8f5e8; color: #2e7d32; }
        .score-good { background: #e3f2fd; color: #1565c0; }
        .score-fair { background: #fff3e0; color: #ef6c00; }
        .score-poor { background: #ffebee; color: #c62828; }
        
        .no-scores {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æœ¬åœ°æˆç¸¾ç®¡ç†å·¥å…·</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-scores">0</div>
                <div class="stat-label">ç¸½æˆç¸¾æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-score">0</div>
                <div class="stat-label">å¹³å‡åˆ†æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highest-score">0</div>
                <div class="stat-label">æœ€é«˜åˆ†æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pending-sync">0</div>
                <div class="stat-label">å¾…åŒæ­¥</div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="refreshScores()">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button onclick="syncAllScores()">ğŸ“¤ åŒæ­¥æ‰€æœ‰æˆç¸¾</button>
            <button onclick="exportScores()">ğŸ’¾ åŒ¯å‡ºæˆç¸¾</button>
            <button onclick="clearAllScores()" style="background: linear-gradient(135deg, #f44336, #d32f2f);">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æˆç¸¾</button>
        </div>
        
        <div class="scores-table">
            <div id="scores-content">
                <div class="no-scores">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 70) return 'score-fair';
            return 'score-poor';
        }
        
        function formatTime(ms) {
            const seconds = Math.round(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString('zh-TW');
        }
        
        function loadLocalScores() {
            const scores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            
            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('total-scores').textContent = scores.length;
            
            if (scores.length > 0) {
                const totalScore = scores.reduce((sum, score) => sum + score.score, 0);
                const avgScore = Math.round(totalScore / scores.length);
                const highestScore = Math.max(...scores.map(score => score.score));
                
                document.getElementById('avg-score').textContent = avgScore;
                document.getElementById('highest-score').textContent = highestScore;
                document.getElementById('pending-sync').textContent = scores.length;
                
                // é¡¯ç¤ºæˆç¸¾è¡¨æ ¼
                const tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸæ™‚é–“</th>
                                <th>ç”¨æˆ¶</th>
                                <th>åˆ†æ•¸</th>
                                <th>æ­£ç¢ºé¡Œæ•¸</th>
                                <th>è€—æ™‚</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${scores.map((score, index) => `
                                <tr>
                                    <td>${formatDate(score.createdAt)}</td>
                                    <td>${score.userName || 'æœªå‘½åä½¿ç”¨è€…'}</td>
                                    <td><span class="score-badge ${getScoreClass(score.score)}">${score.score}åˆ†</span></td>
                                    <td>${score.correctCount || 'æœªçŸ¥'}/${score.questionCount || 'æœªçŸ¥'}</td>
                                    <td>${formatTime(score.timeSpentMs || 0)}</td>
                                    <td>${score.savedLocally ? 'æœ¬åœ°å­˜å„²' : 'å·²åŒæ­¥'}</td>
                                    <td>
                                        <button onclick="syncSingleScore(${index})" style="padding: 4px 8px; font-size: 12px;">åŒæ­¥</button>
                                        <button onclick="deleteScore(${index})" style="padding: 4px 8px; font-size: 12px; background: #f44336;">åˆªé™¤</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                document.getElementById('scores-content').innerHTML = tableHtml;
            } else {
                document.getElementById('avg-score').textContent = '0';
                document.getElementById('highest-score').textContent = '0';
                document.getElementById('pending-sync').textContent = '0';
                document.getElementById('scores-content').innerHTML = '<div class="no-scores">æ²’æœ‰æœ¬åœ°æˆç¸¾</div>';
            }
        }
        
        window.refreshScores = function() {
            log('ğŸ”„ é‡æ–°æ•´ç†æœ¬åœ°æˆç¸¾...');
            loadLocalScores();
        };
        
        window.syncSingleScore = async function(index) {
            const scores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (index >= scores.length) return;
            
            const score = scores[index];
            log(`ğŸ“¤ åŒæ­¥æˆç¸¾ ${index + 1}: ${score.score}åˆ†...`);
            
            try {
                // é€™è£¡éœ€è¦å°å…¥æˆç¸¾æœå‹™
                const { createSequentialScore } = await import('./src/services/scoreSeqService.js');
                
                const payload = {
                    uid: score.uid,
                    userName: score.userName,
                    score: score.score,
                    timeSpentMs: score.timeSpentMs,
                    startedAt: score.startedAt,
                    correctCount: score.correctCount,
                    questionCount: score.questionCount,
                    examType: score.examType,
                    submittedAt: serverTimestamp(),
                    clientInfo: {
                        appVersion: 'quiz v1.0.0',
                        ua: navigator.userAgent,
                        timestamp: Date.now()
                    }
                };
                
                const docId = await createSequentialScore(payload);
                log(`âœ… æˆç¸¾åŒæ­¥æˆåŠŸ: ${docId}`);
                
                // ç§»é™¤å·²åŒæ­¥çš„æˆç¸¾
                scores.splice(index, 1);
                localStorage.setItem('pbls_local_scores', JSON.stringify(scores));
                
                loadLocalScores();
                
            } catch (error) {
                log(`âŒ åŒæ­¥å¤±æ•—: ${error.message}`);
            }
        };
        
        window.syncAllScores = async function() {
            const scores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (scores.length === 0) {
                log('ğŸ“‹ æ²’æœ‰éœ€è¦åŒæ­¥çš„æˆç¸¾');
                return;
            }
            
            log(`ğŸ“¤ é–‹å§‹åŒæ­¥ ${scores.length} ç­†æˆç¸¾...`);
            
            try {
                const { createSequentialScore } = await import('./src/services/scoreSeqService.js');
                let syncedCount = 0;
                
                for (let i = scores.length - 1; i >= 0; i--) {
                    const score = scores[i];
                    try {
                        const payload = {
                            uid: score.uid,
                            userName: score.userName,
                            score: score.score,
                            timeSpentMs: score.timeSpentMs,
                            startedAt: score.startedAt,
                            correctCount: score.correctCount,
                            questionCount: score.questionCount,
                            examType: score.examType,
                            submittedAt: serverTimestamp(),
                            clientInfo: {
                                appVersion: 'quiz v1.0.0',
                                ua: navigator.userAgent,
                                timestamp: Date.now()
                            }
                        };
                        
                        await createSequentialScore(payload);
                        scores.splice(i, 1);
                        syncedCount++;
                        log(`âœ… åŒæ­¥ç¬¬ ${syncedCount} ç­†æˆç¸¾æˆåŠŸ`);
                        
                    } catch (error) {
                        log(`âŒ åŒæ­¥ç¬¬ ${i + 1} ç­†æˆç¸¾å¤±æ•—: ${error.message}`);
                    }
                }
                
                localStorage.setItem('pbls_local_scores', JSON.stringify(scores));
                log(`ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ ${syncedCount} ç­†ï¼Œå‰©é¤˜ ${scores.length} ç­†`);
                
                loadLocalScores();
                
            } catch (error) {
                log(`âŒ åŒæ­¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        };
        
        window.deleteScore = function(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æˆç¸¾å—ï¼Ÿ')) return;
            
            const scores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (index >= scores.length) return;
            
            const score = scores[index];
            scores.splice(index, 1);
            localStorage.setItem('pbls_local_scores', JSON.stringify(scores));
            
            log(`ğŸ—‘ï¸ å·²åˆªé™¤æˆç¸¾: ${score.score}åˆ†`);
            loadLocalScores();
        };
        
        window.exportScores = function() {
            const scores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (scores.length === 0) {
                log('ğŸ“‹ æ²’æœ‰æˆç¸¾å¯ä»¥åŒ¯å‡º');
                return;
            }
            
            const csvContent = [
                'æ—¥æœŸæ™‚é–“,ç”¨æˆ¶,åˆ†æ•¸,æ­£ç¢ºé¡Œæ•¸,ç¸½é¡Œæ•¸,è€—æ™‚(ç§’),æ¸¬é©—é¡å‹',
                ...scores.map(score => 
                    `${formatDate(score.createdAt)},${score.userName || 'æœªå‘½åä½¿ç”¨è€…'},${score.score},${score.correctCount || 'æœªçŸ¥'},${score.questionCount || 'æœªçŸ¥'},${Math.round((score.timeSpentMs || 0) / 1000)},${score.examType}`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `pbls_scores_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            log(`ğŸ’¾ å·²åŒ¯å‡º ${scores.length} ç­†æˆç¸¾`);
        };
        
        window.clearAllScores = function() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æˆç¸¾å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            localStorage.removeItem('pbls_local_scores');
            log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°æˆç¸¾');
            loadLocalScores();
        };
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸ“„ æœ¬åœ°æˆç¸¾ç®¡ç†å·¥å…·å·²è¼‰å…¥');
            loadLocalScores();
        });
    </script>
</body>
</html>
