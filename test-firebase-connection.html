<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯• Firebase è¿æ¥</title>
</head>
<body>
    <h1>Firebase è¿æ¥æµ‹è¯•</h1>
    <button onclick="testFirebase()">æµ‹è¯• Firebase</button>
    <button onclick="testSave()">æµ‹è¯•ä¿å­˜</button>
    <div id="result"></div>

    <!-- 1. å…ˆè¼‰å…¥ firebase.js -->
    <script type="module" src="./js/firebase.js"></script>
    
    <script>
        function testFirebase() {
            const resultDiv = document.getElementById('result');
            
            console.log("ğŸ” æµ‹è¯• Firebase åˆå§‹åŒ–...");
            
            if (window.__FB__) {
                console.log("âœ… window.__FB__ å­˜åœ¨");
                console.log("app:", !!window.__FB__.app);
                console.log("auth:", !!window.__FB__.auth);
                console.log("db:", !!window.__FB__.db);
                
                if (window.__FB__.auth?.currentUser) {
                    console.log("âœ… ç”¨æˆ·å·²ç™»å½•:", window.__FB__.auth.currentUser.uid);
                    console.log("åŒ¿åç”¨æˆ·:", window.__FB__.auth.currentUser.isAnonymous);
                    resultDiv.innerHTML = '<p style="color: green;">âœ… Firebase åˆå§‹åŒ–æˆåŠŸï¼Œç”¨æˆ·å·²ç™»å½•</p>';
                } else {
                    console.log("âš ï¸ ç”¨æˆ·æœªç™»å½•");
                    resultDiv.innerHTML = '<p style="color: orange;">âš ï¸ Firebase åˆå§‹åŒ–æˆåŠŸï¼Œä½†ç”¨æˆ·æœªç™»å½•</p>';
                }
            } else {
                console.error("âŒ window.__FB__ ä¸å­˜åœ¨");
                resultDiv.innerHTML = '<p style="color: red;">âŒ Firebase åˆå§‹åŒ–å¤±è´¥</p>';
            }
        }
        
        async function testSave() {
            const resultDiv = document.getElementById('result');
            
            try {
                console.log("ğŸ” æµ‹è¯•ä¿å­˜åˆ° Firestore...");
                
                if (!window.__FB__?.auth?.currentUser) {
                    console.log("ğŸ” ç”¨æˆ·æœªç™»å½•ï¼Œå°è¯•åŒ¿åç™»å½•...");
                    const { signInAnonymously } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
                    await signInAnonymously(window.__FB__.auth);
                    console.log("âœ… åŒ¿åç™»å½•æˆåŠŸ");
                }
                
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
                
                const testData = {
                    uid: window.__FB__.auth.currentUser.uid,
                    userName: "æµ‹è¯•ç”¨æˆ·",
                    score: 100,
                    testTime: serverTimestamp()
                };
                
                console.log("ğŸ“Š å‡†å¤‡ä¿å­˜æµ‹è¯•æ•°æ®:", testData);
                
                const docRef = await addDoc(collection(window.__FB__.db, "scores"), testData);
                
                console.log("âœ… æµ‹è¯•æ•°æ®ä¿å­˜æˆåŠŸï¼Œæ–‡æ¡£ ID:", docRef.id);
                resultDiv.innerHTML = '<p style="color: green;">âœ… æµ‹è¯•ä¿å­˜æˆåŠŸï¼æ–‡æ¡£ ID: ' + docRef.id + '</p>';
                
            } catch (error) {
                console.error("âŒ æµ‹è¯•ä¿å­˜å¤±è´¥:", error);
                resultDiv.innerHTML = '<p style="color: red;">âŒ æµ‹è¯•ä¿å­˜å¤±è´¥: ' + error.message + '</p>';
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(testFirebase, 1000);
        });
    </script>
</body>
</html>
