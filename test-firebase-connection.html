<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试 Firebase 连接</title>
</head>
<body>
    <h1>Firebase 连接测试</h1>
    <button onclick="testFirebase()">测试 Firebase</button>
    <button onclick="testSave()">测试保存</button>
    <div id="result"></div>

    <!-- 1. 先載入 firebase.js -->
    <script type="module" src="./js/firebase.js"></script>
    
    <script>
        function testFirebase() {
            const resultDiv = document.getElementById('result');
            
            console.log("🔍 测试 Firebase 初始化...");
            
            if (window.__FB__) {
                console.log("✅ window.__FB__ 存在");
                console.log("app:", !!window.__FB__.app);
                console.log("auth:", !!window.__FB__.auth);
                console.log("db:", !!window.__FB__.db);
                
                if (window.__FB__.auth?.currentUser) {
                    console.log("✅ 用户已登录:", window.__FB__.auth.currentUser.uid);
                    console.log("匿名用户:", window.__FB__.auth.currentUser.isAnonymous);
                    resultDiv.innerHTML = '<p style="color: green;">✅ Firebase 初始化成功，用户已登录</p>';
                } else {
                    console.log("⚠️ 用户未登录");
                    resultDiv.innerHTML = '<p style="color: orange;">⚠️ Firebase 初始化成功，但用户未登录</p>';
                }
            } else {
                console.error("❌ window.__FB__ 不存在");
                resultDiv.innerHTML = '<p style="color: red;">❌ Firebase 初始化失败</p>';
            }
        }
        
        async function testSave() {
            const resultDiv = document.getElementById('result');
            
            try {
                console.log("🔍 测试保存到 Firestore...");
                
                if (!window.__FB__?.auth?.currentUser) {
                    console.log("🔐 用户未登录，尝试匿名登录...");
                    const { signInAnonymously } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js");
                    await signInAnonymously(window.__FB__.auth);
                    console.log("✅ 匿名登录成功");
                }
                
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js");
                
                const testData = {
                    uid: window.__FB__.auth.currentUser.uid,
                    userName: "测试用户",
                    score: 100,
                    testTime: serverTimestamp()
                };
                
                console.log("📊 准备保存测试数据:", testData);
                
                const docRef = await addDoc(collection(window.__FB__.db, "scores"), testData);
                
                console.log("✅ 测试数据保存成功，文档 ID:", docRef.id);
                resultDiv.innerHTML = '<p style="color: green;">✅ 测试保存成功！文档 ID: ' + docRef.id + '</p>';
                
            } catch (error) {
                console.error("❌ 测试保存失败:", error);
                resultDiv.innerHTML = '<p style="color: red;">❌ 测试保存失败: ' + error.message + '</p>';
            }
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            setTimeout(testFirebase, 1000);
        });
    </script>
</body>
</html>
