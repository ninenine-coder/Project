    <!-- 先載入共用 firebase.js（內要 export { auth, db } 並掛 window.__FB__） -->
    <script type="module" src="./js/firebase.js"></script>

    <script type="module">
      import { auth, db } from './js/firebase.js';
      import {
        collection, query, where, orderBy, limit, onSnapshot
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
      import { signInAnonymously, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

      const tbody = document.getElementById('rows');

      // 取得「學號/工號」（你登入時已存過）
      function getUserKey() {
        try {
          const p = JSON.parse(localStorage.getItem('pbls_user_profile') || 'null');
          // 依你專案的欄位順序取值
          return p?.学号 || p?.工号 || p?.name || p?.studentId || null;
        } catch { return null; }
      }

      // 時間/分數/題數格式化
      const fmtTime = v => {
        try {
          if (v?.toDate) return v.toDate().toLocaleString();
          if (v?.seconds) return new Date(v.seconds * 1000).toLocaleString(); // Timestamp-like
          if (typeof v === 'string' || typeof v === 'number') return new Date(v).toLocaleString();
        } catch {}
        return '-';
      };
      const fmtDuration = v => {
        if (v == null) return '-';
        const ms = v > 1e6 ? v : v * 1000; // 兼容秒/毫秒
        const s = Math.max(0, Math.round(ms / 1000));
        return `${Math.floor(s/60)}分${s%60}秒`;
      };
      const scoreText = r =>
        r.scorePct != null ? Math.round(r.scorePct * 100) + '%' :
        r.scoreRaw != null ? r.scoreRaw :
        r.score     != null ? r.score     : '-';
      const solvedText = r => {
        const c = r.correctCount ?? r.correct ?? null;
        const t = r.totalQuestions ?? r.questionCount ?? null;
        return (c==null && t==null) ? '-' : `${c ?? '-'} / ${t ?? '-'}`;
      };

      function renderRows(rows) {
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;padding:24px">目前沒有任何成績紀錄</td></tr>`;
          return;
        }
        tbody.innerHTML = rows.map(r => {
          const submitted = fmtTime(r.submittedAt);
          const title = r.examTitle || r.examId || r.examType || '(未命名)';
          const dur = fmtDuration(r.timeSpentMs ?? r.durationMs ?? r.durationSec);
          return `<tr>
            <td class="exam-title">${title}</td>
            <td>${submitted}</td>
            <td>${scoreText(r)}</td>
            <td>${solvedText(r)}</td>
            <td>${dur}</td>
            <td><a class="btn" href="result.html?attemptId=${encodeURIComponent(r.id)}">查看</a></td>
          </tr>`;
        }).join('');
      }

      async function ensureSignedIn() {
        if (auth.currentUser) return auth.currentUser;
        const cred = await signInAnonymously(auth);
        return cred.user;
      }

      // 監聽本人（學號/工號）所有成績，時間倒序
      function listenMyScores(userKey) {
        // 先試着用 submittedAt 排序（是 Timestamp 時最準確）
        let qref;
        try {
          qref = query(
            collection(db, 'scores'),
            where('userName', '==', userKey),
            orderBy('submittedAt', 'desc'),
            limit(100)
          );
          return onSnapshot(qref, snap => {
            const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderRows(rows);
          });
        } catch (e) {
          // 如果 submittedAt 是字串 → Firestore 有時不讓 orderBy；改為前端排序
          qref = query(
            collection(db, 'scores'),
            where('userName', '==', userKey),
            limit(100)
          );
          return onSnapshot(qref, snap => {
            const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            rows.sort((a,b) => {
              const A = a.submittedAt?.seconds ? a.submittedAt.seconds*1000
                     : a.submittedAt?.toDate ? a.submittedAt.toDate().getTime()
                     : Date.parse(a.submittedAt) || 0;
              const B = b.submittedAt?.seconds ? b.submittedAt.seconds*1000
                     : b.submittedAt?.toDate ? b.submittedAt.toDate().getTime()
                     : Date.parse(b.submittedAt) || 0;
              return B - A;
            });
            renderRows(rows);
          });
        }
      }

      onAuthStateChanged(auth, async () => {
        try {
          const userKey = getUserKey();
          if (!userKey) {
            alert('找不到學號/工號，請重新登入'); 
            location.href = 'login.html';
            return;
          }
          await ensureSignedIn();          // ★ 必須登入（匿名也可），規則才允許 read
          listenMyScores(userKey);         // ★ 即時監聽 → 交卷後會立即出現在列表
        } catch (e) {
          console.error('歷史成績載入失敗：', e.code || e.name, e.message || e);
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#b91c1c;padding:24px">讀取失敗：${e.code || e.message}</td></tr>`;
        }
      });
    </script>
</body>
</html>
