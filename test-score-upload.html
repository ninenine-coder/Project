<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç¸¾ä¸Šå‚³æ¸¬è©¦å·¥å…· - PBLS VRæ•™å­¸å¹³å°</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #e8d5ff 0%, #d1c4e9 50%, #b39ddb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #4a148c;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e1bee7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #4a148c;
        }
        
        .status-value {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #7b1fa2, #512da8);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            border: 1px solid #e1bee7;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æˆç¸¾ä¸Šå‚³æ¸¬è©¦å·¥å…·</h1>
        
        <div class="status-card">
            <h3>ğŸ“Š ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h3>
            <div class="status-item">
                <span class="status-label">Firebase é€£æ¥</span>
                <span class="status-value status-info" id="firebase-status">æª¢æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç”¨æˆ¶èªè­‰</span>
                <span class="status-value status-info" id="auth-status">æª¢æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Firestore è¦å‰‡</span>
                <span class="status-value status-info" id="rules-status">æª¢æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">è¨ˆæ•¸å™¨é›†åˆ</span>
                <span class="status-value status-info" id="counter-status">æª¢æŸ¥ä¸­...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ æˆç¸¾ä¸Šå‚³æ¸¬è©¦</h3>
            <div class="controls">
                <button onclick="testCounterAccess()">ğŸ”¢ æ¸¬è©¦è¨ˆæ•¸å™¨å­˜å–</button>
                <button onclick="testScoreUpload()">ğŸ“¤ æ¸¬è©¦æˆç¸¾ä¸Šå‚³</button>
                <button onclick="testBatchUpload()">ğŸ“¦ æ¸¬è©¦æ‰¹é‡ä¸Šå‚³</button>
                <button onclick="checkExistingScores()">ğŸ“‹ æª¢æŸ¥ç¾æœ‰æˆç¸¾</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”„ æœ¬åœ°æˆç¸¾åŒæ­¥æ¸¬è©¦</h3>
            <div class="controls">
                <button onclick="createTestLocalScore()">â• å‰µå»ºæ¸¬è©¦æœ¬åœ°æˆç¸¾</button>
                <button onclick="syncLocalScores()">ğŸ”„ åŒæ­¥æœ¬åœ°æˆç¸¾</button>
                <button onclick="clearLocalScores()">ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°æˆç¸¾</button>
            </div>
        </div>
        
        <div class="log" id="log">ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n</div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { 
            collection, 
            doc, 
            getDocs, 
            getDoc, 
            query, 
            limit, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { createSequentialScore } from './src/services/scoreSeqService.js';

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-value status-${status}`;
        }
        
        async function checkSystemStatus() {
            log('ğŸ” é–‹å§‹ç³»çµ±ç‹€æ…‹æª¢æŸ¥...');
            
            try {
                // æª¢æŸ¥ Firebase é€£æ¥
                updateStatus('firebase-status', 'info', 'æª¢æŸ¥ä¸­...');
                await getDocs(query(collection(db, 'counters'), limit(1)));
                updateStatus('firebase-status', 'success', 'âœ… æ­£å¸¸');
                log('âœ… Firebase é€£æ¥æ­£å¸¸');
                
                // æª¢æŸ¥ç”¨æˆ¶èªè­‰
                updateStatus('auth-status', 'info', 'æª¢æŸ¥ä¸­...');
                if (auth.currentUser) {
                    updateStatus('auth-status', 'success', `âœ… ${auth.currentUser.uid.substring(0, 8)}...`);
                    log(`âœ… ç”¨æˆ¶å·²èªè­‰: ${auth.currentUser.uid}`);
                } else {
                    updateStatus('auth-status', 'warning', 'âš ï¸ æœªèªè­‰');
                    log('âš ï¸ ç”¨æˆ¶æœªèªè­‰');
                }
                
                // æª¢æŸ¥ Firestore è¦å‰‡ï¼ˆé€šéå˜—è©¦è®€å–ï¼‰
                updateStatus('rules-status', 'info', 'æª¢æŸ¥ä¸­...');
                try {
                    await getDoc(doc(db, 'counters', 'scores'));
                    updateStatus('rules-status', 'success', 'âœ… è¦å‰‡æ­£å¸¸');
                    log('âœ… Firestore è¦å‰‡æª¢æŸ¥é€šé');
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        updateStatus('rules-status', 'error', 'âŒ æ¬Šé™ä¸è¶³');
                        log('âŒ Firestore æ¬Šé™ä¸è¶³');
                    } else {
                        updateStatus('rules-status', 'warning', 'âš ï¸ è¦å‰‡å•é¡Œ');
                        log(`âš ï¸ Firestore è¦å‰‡æª¢æŸ¥å¤±æ•—: ${error.message}`);
                    }
                }
                
                // æª¢æŸ¥è¨ˆæ•¸å™¨é›†åˆ
                updateStatus('counter-status', 'info', 'æª¢æŸ¥ä¸­...');
                try {
                    const counterDoc = await getDoc(doc(db, 'counters', 'scores'));
                    if (counterDoc.exists()) {
                        const nextValue = counterDoc.data().next;
                        updateStatus('counter-status', 'success', `âœ… ä¸‹ä¸€å€‹: ${nextValue}`);
                        log(`âœ… è¨ˆæ•¸å™¨æ­£å¸¸ï¼Œä¸‹ä¸€å€‹åºè™Ÿ: ${nextValue}`);
                    } else {
                        updateStatus('counter-status', 'info', 'â„¹ï¸ æœªåˆå§‹åŒ–');
                        log('â„¹ï¸ è¨ˆæ•¸å™¨å°šæœªåˆå§‹åŒ–ï¼Œå°‡åœ¨é¦–æ¬¡ä¸Šå‚³æ™‚å‰µå»º');
                    }
                } catch (error) {
                    updateStatus('counter-status', 'error', 'âŒ å­˜å–å¤±æ•—');
                    log(`âŒ è¨ˆæ•¸å™¨å­˜å–å¤±æ•—: ${error.message}`);
                }
                
            } catch (error) {
                log(`âŒ ç³»çµ±ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`);
                updateStatus('firebase-status', 'error', 'âŒ é€£æ¥å¤±æ•—');
            }
        }
        
        window.testCounterAccess = async function() {
            log('ğŸ”¢ æ¸¬è©¦è¨ˆæ•¸å™¨å­˜å–...');
            
            try {
                const counterRef = doc(db, 'counters', 'scores');
                const counterSnap = await getDoc(counterRef);
                
                if (counterSnap.exists()) {
                    const data = counterSnap.data();
                    log(`âœ… è¨ˆæ•¸å™¨å­˜åœ¨ï¼Œç•¶å‰å€¼: ${data.next}`);
                } else {
                    log('â„¹ï¸ è¨ˆæ•¸å™¨ä¸å­˜åœ¨ï¼Œå°‡åœ¨é¦–æ¬¡ä¸Šå‚³æ™‚å‰µå»º');
                }
                
                // æ¸¬è©¦å¯«å…¥æ¬Šé™
                log('ğŸ“ æ¸¬è©¦å¯«å…¥æ¬Šé™...');
                // é€™è£¡ä¸å¯¦éš›å¯«å…¥ï¼Œåªæ¸¬è©¦æ¬Šé™
                log('âœ… è¨ˆæ•¸å™¨å­˜å–æ¸¬è©¦å®Œæˆ');
                
            } catch (error) {
                log(`âŒ è¨ˆæ•¸å™¨å­˜å–å¤±æ•—: ${error.message}`);
            }
        };
        
        window.testScoreUpload = async function() {
            log('ğŸ“¤ é–‹å§‹æ¸¬è©¦æˆç¸¾ä¸Šå‚³...');
            
            try {
                if (!auth.currentUser) {
                    log('âŒ ç”¨æˆ¶æœªèªè­‰ï¼Œç„¡æ³•æ¸¬è©¦ä¸Šå‚³');
                    return;
                }
                
                const testScore = {
                    uid: auth.currentUser.uid,
                    userName: 'æ¸¬è©¦ç”¨æˆ¶',
                    score: Math.floor(Math.random() * 100) + 1,
                    timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                    startedAt: Date.now() - 300000,
                    correctCount: Math.floor(Math.random() * 20) + 1,
                    questionCount: 20,
                    examType: 'æ¸¬è©¦æ¸¬é©—',
                    submittedAt: serverTimestamp(),
                    clientInfo: {
                        appVersion: 'quiz v1.0.0',
                        ua: navigator.userAgent,
                        timestamp: Date.now()
                    }
                };
                
                log(`ğŸ“Š æº–å‚™ä¸Šå‚³æ¸¬è©¦æˆç¸¾: ${testScore.score}åˆ†`);
                
                const docId = await createSequentialScore(testScore);
                log(`âœ… æˆç¸¾ä¸Šå‚³æˆåŠŸï¼æ–‡ä»¶ ID: ${docId}`);
                
                // é©—è­‰ä¸Šå‚³çµæœ
                const uploadedDoc = await getDoc(doc(db, 'scores', docId));
                if (uploadedDoc.exists()) {
                    const data = uploadedDoc.data();
                    log(`âœ… é©—è­‰æˆåŠŸï¼Œä¸Šå‚³çš„åˆ†æ•¸: ${data.score}åˆ†`);
                } else {
                    log('âš ï¸ ä¸Šå‚³å¾Œç„¡æ³•æ‰¾åˆ°æ–‡ä»¶');
                }
                
            } catch (error) {
                log(`âŒ æˆç¸¾ä¸Šå‚³å¤±æ•—: ${error.message}`);
                if (error.code) {
                    log(`   éŒ¯èª¤ä»£ç¢¼: ${error.code}`);
                }
            }
        };
        
        window.testBatchUpload = async function() {
            log('ğŸ“¦ é–‹å§‹æ‰¹é‡ä¸Šå‚³æ¸¬è©¦...');
            
            try {
                if (!auth.currentUser) {
                    log('âŒ ç”¨æˆ¶æœªèªè­‰ï¼Œç„¡æ³•æ¸¬è©¦æ‰¹é‡ä¸Šå‚³');
                    return;
                }
                
                const batchSize = 3;
                const results = [];
                
                for (let i = 0; i < batchSize; i++) {
                    try {
                        const testScore = {
                            uid: auth.currentUser.uid,
                            userName: 'æ‰¹é‡æ¸¬è©¦ç”¨æˆ¶',
                            score: Math.floor(Math.random() * 100) + 1,
                            timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                            startedAt: Date.now() - 300000,
                            correctCount: Math.floor(Math.random() * 20) + 1,
                            questionCount: 20,
                            examType: 'æ‰¹é‡æ¸¬è©¦',
                            submittedAt: serverTimestamp(),
                            clientInfo: {
                                appVersion: 'quiz v1.0.0',
                                ua: navigator.userAgent,
                                timestamp: Date.now()
                            }
                        };
                        
                        const docId = await createSequentialScore(testScore);
                        results.push(docId);
                        log(`âœ… æ‰¹é‡ä¸Šå‚³ ${i + 1}/${batchSize}: ${docId}`);
                        
                        // ç¨å¾®å»¶é²é¿å…éå¿«
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        log(`âŒ æ‰¹é‡ä¸Šå‚³ ${i + 1} å¤±æ•—: ${error.message}`);
                    }
                }
                
                log(`ğŸ‰ æ‰¹é‡ä¸Šå‚³å®Œæˆï¼ŒæˆåŠŸ ${results.length}/${batchSize} ç­†`);
                
            } catch (error) {
                log(`âŒ æ‰¹é‡ä¸Šå‚³æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        };
        
        window.checkExistingScores = async function() {
            log('ğŸ“‹ æª¢æŸ¥ç¾æœ‰æˆç¸¾...');
            
            try {
                const scoresQuery = query(
                    collection(db, 'scores'),
                    orderBy('submittedAt', 'desc'),
                    limit(10)
                );
                
                const snapshot = await getDocs(scoresQuery);
                
                if (snapshot.empty) {
                    log('ğŸ“‹ ç›®å‰æ²’æœ‰æˆç¸¾è¨˜éŒ„');
                } else {
                    log(`ğŸ“‹ æ‰¾åˆ° ${snapshot.size} ç­†æœ€æ–°æˆç¸¾:`);
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = data.submittedAt?.toDate?.() || new Date();
                        log(`  ${index + 1}. ${doc.id}: ${data.score}åˆ† (${data.userName || 'æœªçŸ¥ç”¨æˆ¶'}) - ${date.toLocaleString()}`);
                    });
                }
                
            } catch (error) {
                log(`âŒ æª¢æŸ¥ç¾æœ‰æˆç¸¾å¤±æ•—: ${error.message}`);
            }
        };
        
        window.createTestLocalScore = function() {
            log('â• å‰µå»ºæ¸¬è©¦æœ¬åœ°æˆç¸¾...');
            
            const testScore = {
                uid: 'test-user-' + Date.now(),
                userName: 'æœ¬åœ°æ¸¬è©¦ç”¨æˆ¶',
                score: Math.floor(Math.random() * 100) + 1,
                timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                startedAt: Date.now() - 300000,
                correctCount: Math.floor(Math.random() * 20) + 1,
                questionCount: 20,
                examType: 'æœ¬åœ°æ¸¬è©¦',
                createdAt: new Date().toISOString(),
                savedLocally: true
            };
            
            const existingScores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            existingScores.push(testScore);
            localStorage.setItem('pbls_local_scores', JSON.stringify(existingScores));
            
            log(`âœ… æœ¬åœ°æˆç¸¾å‰µå»ºæˆåŠŸ: ${testScore.score}åˆ†`);
            log(`ğŸ“Š æœ¬åœ°æˆç¸¾ç¸½æ•¸: ${existingScores.length}`);
        };
        
        window.syncLocalScores = async function() {
            log('ğŸ”„ é–‹å§‹åŒæ­¥æœ¬åœ°æˆç¸¾...');
            
            const localScores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (localScores.length === 0) {
                log('ğŸ“‹ æ²’æœ‰æœ¬åœ°æˆç¸¾éœ€è¦åŒæ­¥');
                return;
            }
            
            log(`ğŸ“‹ ç™¼ç¾ ${localScores.length} ç­†æœ¬åœ°æˆç¸¾`);
            
            if (!auth.currentUser) {
                log('âŒ ç”¨æˆ¶æœªèªè­‰ï¼Œç„¡æ³•åŒæ­¥');
                return;
            }
            
            let syncedCount = 0;
            
            for (let i = localScores.length - 1; i >= 0; i--) {
                const score = localScores[i];
                try {
                    const payload = {
                        uid: auth.currentUser.uid,
                        userName: score.userName,
                        score: score.score,
                        timeSpentMs: score.timeSpentMs,
                        startedAt: score.startedAt,
                        correctCount: score.correctCount,
                        questionCount: score.questionCount,
                        examType: score.examType,
                        submittedAt: serverTimestamp(),
                        clientInfo: {
                            appVersion: 'quiz v1.0.0',
                            ua: navigator.userAgent,
                            timestamp: Date.now()
                        }
                    };
                    
                    const docId = await createSequentialScore(payload);
                    localScores.splice(i, 1);
                    syncedCount++;
                    log(`âœ… åŒæ­¥æˆåŠŸ ${syncedCount}: ${docId}`);
                    
                } catch (error) {
                    log(`âŒ åŒæ­¥å¤±æ•—: ${error.message}`);
                }
            }
            
            localStorage.setItem('pbls_local_scores', JSON.stringify(localScores));
            log(`ğŸ‰ åŒæ­¥å®Œæˆï¼æˆåŠŸ ${syncedCount} ç­†ï¼Œå‰©é¤˜ ${localScores.length} ç­†`);
        };
        
        window.clearLocalScores = function() {
            localStorage.removeItem('pbls_local_scores');
            log('ğŸ—‘ï¸ æœ¬åœ°æˆç¸¾å·²æ¸…é™¤');
        };
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        window.addEventListener('load', () => {
            log('ğŸš€ æˆç¸¾ä¸Šå‚³æ¸¬è©¦å·¥å…·å·²è¼‰å…¥');
            checkSystemStatus();
        });
        
        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`ğŸ‘¤ ç”¨æˆ¶èªè­‰ç‹€æ…‹è®ŠåŒ–: ${user.uid}`);
                updateStatus('auth-status', 'success', `âœ… ${user.uid.substring(0, 8)}...`);
            } else {
                log('ğŸ‘¤ ç”¨æˆ¶å·²ç™»å‡º');
                updateStatus('auth-status', 'warning', 'âš ï¸ æœªèªè­‰');
            }
        });
    </script>
</body>
</html>
