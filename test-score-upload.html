<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績上傳測試工具 - PBLS VR教學平台</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #e8d5ff 0%, #d1c4e9 50%, #b39ddb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #4a148c;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #e1bee7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #4a148c;
        }
        
        .status-value {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-error {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-info {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #9c27b0, #673ab7);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #7b1fa2, #512da8);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            border: 1px solid #e1bee7;
        }
        
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 成績上傳測試工具</h1>
        
        <div class="status-card">
            <h3>📊 系統狀態檢查</h3>
            <div class="status-item">
                <span class="status-label">Firebase 連接</span>
                <span class="status-value status-info" id="firebase-status">檢查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">用戶認證</span>
                <span class="status-value status-info" id="auth-status">檢查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Firestore 規則</span>
                <span class="status-value status-info" id="rules-status">檢查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">計數器集合</span>
                <span class="status-value status-info" id="counter-status">檢查中...</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🎯 成績上傳測試</h3>
            <div class="controls">
                <button onclick="testCounterAccess()">🔢 測試計數器存取</button>
                <button onclick="testScoreUpload()">📤 測試成績上傳</button>
                <button onclick="testBatchUpload()">📦 測試批量上傳</button>
                <button onclick="checkExistingScores()">📋 檢查現有成績</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🔄 本地成績同步測試</h3>
            <div class="controls">
                <button onclick="createTestLocalScore()">➕ 創建測試本地成績</button>
                <button onclick="syncLocalScores()">🔄 同步本地成績</button>
                <button onclick="clearLocalScores()">🗑️ 清除本地成績</button>
            </div>
        </div>
        
        <div class="log" id="log">等待測試開始...\n</div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { 
            collection, 
            doc, 
            getDocs, 
            getDoc, 
            query, 
            limit, 
            orderBy, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { createSequentialScore } from './src/services/scoreSeqService.js';

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status-value status-${status}`;
        }
        
        async function checkSystemStatus() {
            log('🔍 開始系統狀態檢查...');
            
            try {
                // 檢查 Firebase 連接
                updateStatus('firebase-status', 'info', '檢查中...');
                await getDocs(query(collection(db, 'counters'), limit(1)));
                updateStatus('firebase-status', 'success', '✅ 正常');
                log('✅ Firebase 連接正常');
                
                // 檢查用戶認證
                updateStatus('auth-status', 'info', '檢查中...');
                if (auth.currentUser) {
                    updateStatus('auth-status', 'success', `✅ ${auth.currentUser.uid.substring(0, 8)}...`);
                    log(`✅ 用戶已認證: ${auth.currentUser.uid}`);
                } else {
                    updateStatus('auth-status', 'warning', '⚠️ 未認證');
                    log('⚠️ 用戶未認證');
                }
                
                // 檢查 Firestore 規則（通過嘗試讀取）
                updateStatus('rules-status', 'info', '檢查中...');
                try {
                    await getDoc(doc(db, 'counters', 'scores'));
                    updateStatus('rules-status', 'success', '✅ 規則正常');
                    log('✅ Firestore 規則檢查通過');
                } catch (error) {
                    if (error.code === 'permission-denied') {
                        updateStatus('rules-status', 'error', '❌ 權限不足');
                        log('❌ Firestore 權限不足');
                    } else {
                        updateStatus('rules-status', 'warning', '⚠️ 規則問題');
                        log(`⚠️ Firestore 規則檢查失敗: ${error.message}`);
                    }
                }
                
                // 檢查計數器集合
                updateStatus('counter-status', 'info', '檢查中...');
                try {
                    const counterDoc = await getDoc(doc(db, 'counters', 'scores'));
                    if (counterDoc.exists()) {
                        const nextValue = counterDoc.data().next;
                        updateStatus('counter-status', 'success', `✅ 下一個: ${nextValue}`);
                        log(`✅ 計數器正常，下一個序號: ${nextValue}`);
                    } else {
                        updateStatus('counter-status', 'info', 'ℹ️ 未初始化');
                        log('ℹ️ 計數器尚未初始化，將在首次上傳時創建');
                    }
                } catch (error) {
                    updateStatus('counter-status', 'error', '❌ 存取失敗');
                    log(`❌ 計數器存取失敗: ${error.message}`);
                }
                
            } catch (error) {
                log(`❌ 系統狀態檢查失敗: ${error.message}`);
                updateStatus('firebase-status', 'error', '❌ 連接失敗');
            }
        }
        
        window.testCounterAccess = async function() {
            log('🔢 測試計數器存取...');
            
            try {
                const counterRef = doc(db, 'counters', 'scores');
                const counterSnap = await getDoc(counterRef);
                
                if (counterSnap.exists()) {
                    const data = counterSnap.data();
                    log(`✅ 計數器存在，當前值: ${data.next}`);
                } else {
                    log('ℹ️ 計數器不存在，將在首次上傳時創建');
                }
                
                // 測試寫入權限
                log('📝 測試寫入權限...');
                // 這裡不實際寫入，只測試權限
                log('✅ 計數器存取測試完成');
                
            } catch (error) {
                log(`❌ 計數器存取失敗: ${error.message}`);
            }
        };
        
        window.testScoreUpload = async function() {
            log('📤 開始測試成績上傳...');
            
            try {
                if (!auth.currentUser) {
                    log('❌ 用戶未認證，無法測試上傳');
                    return;
                }
                
                const testScore = {
                    uid: auth.currentUser.uid,
                    userName: '測試用戶',
                    score: Math.floor(Math.random() * 100) + 1,
                    timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                    startedAt: Date.now() - 300000,
                    correctCount: Math.floor(Math.random() * 20) + 1,
                    questionCount: 20,
                    examType: '測試測驗',
                    submittedAt: serverTimestamp(),
                    clientInfo: {
                        appVersion: 'quiz v1.0.0',
                        ua: navigator.userAgent,
                        timestamp: Date.now()
                    }
                };
                
                log(`📊 準備上傳測試成績: ${testScore.score}分`);
                
                const docId = await createSequentialScore(testScore);
                log(`✅ 成績上傳成功！文件 ID: ${docId}`);
                
                // 驗證上傳結果
                const uploadedDoc = await getDoc(doc(db, 'scores', docId));
                if (uploadedDoc.exists()) {
                    const data = uploadedDoc.data();
                    log(`✅ 驗證成功，上傳的分數: ${data.score}分`);
                } else {
                    log('⚠️ 上傳後無法找到文件');
                }
                
            } catch (error) {
                log(`❌ 成績上傳失敗: ${error.message}`);
                if (error.code) {
                    log(`   錯誤代碼: ${error.code}`);
                }
            }
        };
        
        window.testBatchUpload = async function() {
            log('📦 開始批量上傳測試...');
            
            try {
                if (!auth.currentUser) {
                    log('❌ 用戶未認證，無法測試批量上傳');
                    return;
                }
                
                const batchSize = 3;
                const results = [];
                
                for (let i = 0; i < batchSize; i++) {
                    try {
                        const testScore = {
                            uid: auth.currentUser.uid,
                            userName: '批量測試用戶',
                            score: Math.floor(Math.random() * 100) + 1,
                            timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                            startedAt: Date.now() - 300000,
                            correctCount: Math.floor(Math.random() * 20) + 1,
                            questionCount: 20,
                            examType: '批量測試',
                            submittedAt: serverTimestamp(),
                            clientInfo: {
                                appVersion: 'quiz v1.0.0',
                                ua: navigator.userAgent,
                                timestamp: Date.now()
                            }
                        };
                        
                        const docId = await createSequentialScore(testScore);
                        results.push(docId);
                        log(`✅ 批量上傳 ${i + 1}/${batchSize}: ${docId}`);
                        
                        // 稍微延遲避免過快
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        log(`❌ 批量上傳 ${i + 1} 失敗: ${error.message}`);
                    }
                }
                
                log(`🎉 批量上傳完成，成功 ${results.length}/${batchSize} 筆`);
                
            } catch (error) {
                log(`❌ 批量上傳測試失敗: ${error.message}`);
            }
        };
        
        window.checkExistingScores = async function() {
            log('📋 檢查現有成績...');
            
            try {
                const scoresQuery = query(
                    collection(db, 'scores'),
                    orderBy('submittedAt', 'desc'),
                    limit(10)
                );
                
                const snapshot = await getDocs(scoresQuery);
                
                if (snapshot.empty) {
                    log('📋 目前沒有成績記錄');
                } else {
                    log(`📋 找到 ${snapshot.size} 筆最新成績:`);
                    snapshot.forEach((doc, index) => {
                        const data = doc.data();
                        const date = data.submittedAt?.toDate?.() || new Date();
                        log(`  ${index + 1}. ${doc.id}: ${data.score}分 (${data.userName || '未知用戶'}) - ${date.toLocaleString()}`);
                    });
                }
                
            } catch (error) {
                log(`❌ 檢查現有成績失敗: ${error.message}`);
            }
        };
        
        window.createTestLocalScore = function() {
            log('➕ 創建測試本地成績...');
            
            const testScore = {
                uid: 'test-user-' + Date.now(),
                userName: '本地測試用戶',
                score: Math.floor(Math.random() * 100) + 1,
                timeSpentMs: Math.floor(Math.random() * 300000) + 60000,
                startedAt: Date.now() - 300000,
                correctCount: Math.floor(Math.random() * 20) + 1,
                questionCount: 20,
                examType: '本地測試',
                createdAt: new Date().toISOString(),
                savedLocally: true
            };
            
            const existingScores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            existingScores.push(testScore);
            localStorage.setItem('pbls_local_scores', JSON.stringify(existingScores));
            
            log(`✅ 本地成績創建成功: ${testScore.score}分`);
            log(`📊 本地成績總數: ${existingScores.length}`);
        };
        
        window.syncLocalScores = async function() {
            log('🔄 開始同步本地成績...');
            
            const localScores = JSON.parse(localStorage.getItem('pbls_local_scores') || '[]');
            if (localScores.length === 0) {
                log('📋 沒有本地成績需要同步');
                return;
            }
            
            log(`📋 發現 ${localScores.length} 筆本地成績`);
            
            if (!auth.currentUser) {
                log('❌ 用戶未認證，無法同步');
                return;
            }
            
            let syncedCount = 0;
            
            for (let i = localScores.length - 1; i >= 0; i--) {
                const score = localScores[i];
                try {
                    const payload = {
                        uid: auth.currentUser.uid,
                        userName: score.userName,
                        score: score.score,
                        timeSpentMs: score.timeSpentMs,
                        startedAt: score.startedAt,
                        correctCount: score.correctCount,
                        questionCount: score.questionCount,
                        examType: score.examType,
                        submittedAt: serverTimestamp(),
                        clientInfo: {
                            appVersion: 'quiz v1.0.0',
                            ua: navigator.userAgent,
                            timestamp: Date.now()
                        }
                    };
                    
                    const docId = await createSequentialScore(payload);
                    localScores.splice(i, 1);
                    syncedCount++;
                    log(`✅ 同步成功 ${syncedCount}: ${docId}`);
                    
                } catch (error) {
                    log(`❌ 同步失敗: ${error.message}`);
                }
            }
            
            localStorage.setItem('pbls_local_scores', JSON.stringify(localScores));
            log(`🎉 同步完成！成功 ${syncedCount} 筆，剩餘 ${localScores.length} 筆`);
        };
        
        window.clearLocalScores = function() {
            localStorage.removeItem('pbls_local_scores');
            log('🗑️ 本地成績已清除');
        };
        
        // 頁面載入時自動檢查系統狀態
        window.addEventListener('load', () => {
            log('🚀 成績上傳測試工具已載入');
            checkSystemStatus();
        });
        
        // 監聽認證狀態變化
        auth.onAuthStateChanged((user) => {
            if (user) {
                log(`👤 用戶認證狀態變化: ${user.uid}`);
                updateStatus('auth-status', 'success', `✅ ${user.uid.substring(0, 8)}...`);
            } else {
                log('👤 用戶已登出');
                updateStatus('auth-status', 'warning', '⚠️ 未認證');
            }
        });
    </script>
</body>
</html>
