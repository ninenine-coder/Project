<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•è¿å·æˆç»©ä¿å­˜</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ§ª è¿å·æˆç»©ä¿å­˜æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h3>1. Firebase åˆå§‹åŒ–æ£€æŸ¥</h3>
        <button onclick="checkFirebaseInit()">æ£€æŸ¥ Firebase åˆå§‹åŒ–</button>
        <div id="firebase-status" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>2. åŒ¿åç™»å½•æµ‹è¯•</h3>
        <button onclick="testAnonymousLogin()">æµ‹è¯•åŒ¿åç™»å½•</button>
        <div id="auth-status" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>3. è®¡æ•°å™¨çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkCounterStatus()">æ£€æŸ¥è®¡æ•°å™¨çŠ¶æ€</button>
        <button onclick="initializeCounter()">åˆå§‹åŒ–è®¡æ•°å™¨</button>
        <div id="counter-status" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>4. è¿å·æˆç»©ä¿å­˜æµ‹è¯•</h3>
        <button onclick="testSequentialScore()">æµ‹è¯•è¿å·æˆç»©ä¿å­˜</button>
        <button onclick="testMultipleScores()">æµ‹è¯•å¤šæ¬¡ä¿å­˜</button>
        <div id="score-status" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>5. æˆç»©æŸ¥è¯¢æµ‹è¯•</h3>
        <button onclick="testScoreQuery()">æµ‹è¯•æˆç»©æŸ¥è¯¢</button>
        <div id="query-status" class="log"></div>
    </div>

    <!-- åŠ è½½ Firebase -->
    <script type="module" src="./js/firebase.js"></script>
    
    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { createSequentialScore, initializeCounter, getCounterStatus } from './src/services/scoreSeqService.js';
        import {
            collection, query, where, orderBy, getDocs, doc, getDoc, setDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import {
            signInAnonymously as fbSignInAnonymously, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // æš´éœ²åˆ°å…¨å±€
        window.auth = auth;
        window.db = db;
        window.createSequentialScore = createSequentialScore;
        window.initializeCounter = initializeCounter;
        window.getCounterStatus = getCounterStatus;

        // æ£€æŸ¥ Firebase åˆå§‹åŒ–
        window.checkFirebaseInit = function() {
            const status = document.getElementById('firebase-status');
            try {
                if (window.__FB__?.auth && window.__FB__?.db) {
                    status.textContent = 'âœ… Firebase å·²æ­£ç¡®åˆå§‹åŒ–\n' + 
                                       'Auth: ' + !!window.__FB__.auth + '\n' + 
                                       'DB: ' + !!window.__FB__.db + '\n' +
                                       'App: ' + !!window.__FB__.app;
                    status.className = 'log success';
                } else {
                    status.textContent = 'âŒ Firebase æœªæ­£ç¡®åˆå§‹åŒ–\n' + 
                                       'window.__FB__: ' + !!window.__FB__;
                    status.className = 'log error';
                }
            } catch (error) {
                status.textContent = 'âŒ æ£€æŸ¥å¤±è´¥: ' + error.message;
                status.className = 'log error';
            }
        };

        // æµ‹è¯•åŒ¿åç™»å½•
        window.testAnonymousLogin = async function() {
            const status = document.getElementById('auth-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•åŒ¿åç™»å½•...';
                status.className = 'log';
                
                const user = auth.currentUser;
                if (user) {
                    status.textContent = 'âœ… ç”¨æˆ·å·²ç™»å½•\n' +
                                       'UID: ' + user.uid + '\n' +
                                       'åŒ¿å: ' + user.isAnonymous;
                    status.className = 'log success';
                } else {
                    const cred = await fbSignInAnonymously(auth);
                    status.textContent = 'âœ… åŒ¿åç™»å½•æˆåŠŸ\n' +
                                       'UID: ' + cred.user.uid + '\n' +
                                       'åŒ¿å: ' + cred.user.isAnonymous;
                    status.className = 'log success';
                }
            } catch (error) {
                status.textContent = 'âŒ åŒ¿åç™»å½•å¤±è´¥: ' + error.message + '\n' +
                                   'é”™è¯¯ä»£ç : ' + error.code;
                status.className = 'log error';
            }
        };

        // æ£€æŸ¥è®¡æ•°å™¨çŠ¶æ€
        window.checkCounterStatus = async function() {
            const status = document.getElementById('counter-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥è®¡æ•°å™¨çŠ¶æ€...';
                status.className = 'log';
                
                const counterData = await getCounterStatus();
                if (counterData) {
                    status.textContent = 'âœ… è®¡æ•°å™¨çŠ¶æ€:\n' +
                                       'Next: ' + counterData.next + '\n' +
                                       'ä¸‹ä¸€ä¸ªæˆç»© ID: scores' + counterData.next;
                    status.className = 'log success';
                } else {
                    status.textContent = 'âš ï¸ è®¡æ•°å™¨å°šæœªåˆå§‹åŒ–\n' +
                                       'ç‚¹å‡»"åˆå§‹åŒ–è®¡æ•°å™¨"æŒ‰é’®è¿›è¡Œåˆå§‹åŒ–';
                    status.className = 'log';
                }
            } catch (error) {
                status.textContent = 'âŒ æ£€æŸ¥è®¡æ•°å™¨å¤±è´¥: ' + error.message;
                status.className = 'log error';
            }
        };

        // åˆå§‹åŒ–è®¡æ•°å™¨
        window.initializeCounter = async function() {
            const status = document.getElementById('counter-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨åˆå§‹åŒ–è®¡æ•°å™¨...';
                status.className = 'log';
                
                await initializeCounter();
                status.textContent = 'âœ… è®¡æ•°å™¨åˆå§‹åŒ–æˆåŠŸ\n' +
                                   'ä¸‹ä¸€ä¸ªæˆç»© ID å°†æ˜¯: scores1';
                status.className = 'log success';
            } catch (error) {
                status.textContent = 'âŒ åˆå§‹åŒ–è®¡æ•°å™¨å¤±è´¥: ' + error.message;
                status.className = 'log error';
            }
        };

        // æµ‹è¯•è¿å·æˆç»©ä¿å­˜
        window.testSequentialScore = async function() {
            const status = document.getElementById('score-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•è¿å·æˆç»©ä¿å­˜...';
                status.className = 'log';
                
                const user = auth.currentUser;
                if (!user) {
                    status.textContent = 'âŒ ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆæµ‹è¯•åŒ¿åç™»å½•';
                    status.className = 'log error';
                    return;
                }

                const payload = {
                    uid: user.uid,
                    userName: 'æµ‹è¯•ç”¨æˆ·',
                    score: Math.round(Math.random() * 100),
                    timeSpentMs: 30000,
                    startedAt: Date.now() - 30000,
                    correctCount: 8,
                    questionCount: 10,
                    examType: "ç­†è©¦æ¸¬é©—",
                    submittedAt: serverTimestamp(),
                    clientInfo: { 
                        appVersion: 'test v1.0.0', 
                        ua: navigator.userAgent, 
                        timestamp: Date.now() 
                    }
                };

                console.log('ğŸ“Š å‡†å¤‡ä¿å­˜æ•°æ®:', payload);
                const newId = await createSequentialScore(payload);
                
                status.textContent = 'âœ… è¿å·æˆç»©ä¿å­˜æˆåŠŸ\n' +
                                   'Document ID: ' + newId + '\n' +
                                   'åˆ†æ•°: ' + payload.score + '\n' +
                                   'ç”¨æˆ·: ' + payload.userName;
                status.className = 'log success';
                
            } catch (error) {
                status.textContent = 'âŒ è¿å·æˆç»©ä¿å­˜å¤±è´¥: ' + error.message + '\n' +
                                   'é”™è¯¯ä»£ç : ' + error.code + '\n' +
                                   'å®Œæ•´é”™è¯¯: ' + JSON.stringify(error, null, 2);
                status.className = 'log error';
            }
        };

        // æµ‹è¯•å¤šæ¬¡ä¿å­˜
        window.testMultipleScores = async function() {
            const status = document.getElementById('score-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•å¤šæ¬¡è¿å·ä¿å­˜...';
                status.className = 'log';
                
                const user = auth.currentUser;
                if (!user) {
                    status.textContent = 'âŒ ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆæµ‹è¯•åŒ¿åç™»å½•';
                    status.className = 'log error';
                    return;
                }

                const results = [];
                for (let i = 1; i <= 3; i++) {
                    const payload = {
                        uid: user.uid,
                        userName: 'æµ‹è¯•ç”¨æˆ·' + i,
                        score: Math.round(Math.random() * 100),
                        timeSpentMs: 30000 + i * 1000,
                        startedAt: Date.now() - 30000 - i * 1000,
                        correctCount: 7 + i,
                        questionCount: 10,
                        examType: "ç­†è©¦æ¸¬é©—",
                        submittedAt: serverTimestamp(),
                        clientInfo: { 
                            appVersion: 'test v1.0.0', 
                            ua: navigator.userAgent, 
                            timestamp: Date.now() 
                        }
                    };

                    const newId = await createSequentialScore(payload);
                    results.push({ id: newId, score: payload.score });
                    await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿ500ms
                }
                
                let output = 'âœ… å¤šæ¬¡è¿å·ä¿å­˜æˆåŠŸ:\n';
                results.forEach((result, index) => {
                    output += `${index + 1}. ${result.id} - åˆ†æ•°: ${result.score}\n`;
                });
                
                status.textContent = output;
                status.className = 'log success';
                
            } catch (error) {
                status.textContent = 'âŒ å¤šæ¬¡è¿å·ä¿å­˜å¤±è´¥: ' + error.message + '\n' +
                                   'é”™è¯¯ä»£ç : ' + error.code;
                status.className = 'log error';
            }
        };

        // æµ‹è¯•æˆç»©æŸ¥è¯¢
        window.testScoreQuery = async function() {
            const status = document.getElementById('query-status');
            try {
                status.textContent = 'ğŸ”„ æ­£åœ¨æµ‹è¯•æˆç»©æŸ¥è¯¢...';
                status.className = 'log';
                
                const user = auth.currentUser;
                if (!user) {
                    status.textContent = 'âŒ ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆæµ‹è¯•åŒ¿åç™»å½•';
                    status.className = 'log error';
                    return;
                }

                const q = query(
                    collection(db, "scores"),
                    where("uid", "==", user.uid),
                    orderBy("submittedAt", "desc")
                );
                
                const snap = await getDocs(q);
                const results = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                if (results.length === 0) {
                    status.textContent = 'âš ï¸ æœªæ‰¾åˆ°æˆç»©è®°å½•\n' +
                                       'UID: ' + user.uid;
                    status.className = 'log';
                } else {
                    let output = 'âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ' + results.length + ' æ¡è®°å½•:\n\n';
                    results.forEach((data, index) => {
                        output += `${index + 1}. ID: ${data.id}\n`;
                        output += `   åˆ†æ•°: ${data.score}\n`;
                        output += `   ç”¨æˆ·: ${data.userName}\n`;
                        output += `   ç±»å‹: ${data.examType}\n`;
                        output += `   æ—¶é—´: ${data.submittedAt?.toDate?.()?.toLocaleString() || 'æ— æ—¶é—´'}\n\n`;
                    });
                    status.textContent = output;
                    status.className = 'log success';
                }
                
            } catch (error) {
                status.textContent = 'âŒ æˆç»©æŸ¥è¯¢å¤±è´¥: ' + error.message + '\n' +
                                   'é”™è¯¯ä»£ç : ' + error.code;
                status.className = 'log error';
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkFirebaseInit();
                testAnonymousLogin();
                checkCounterStatus();
            }, 1000);
        });
    </script>
</body>
</html>
