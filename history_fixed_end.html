        try {
          snap = await getDocs(q);
        } catch (e) {
          console.warn('orderBy(submittedAt) 失敗，改用不排序：', e.code || e.message);
          snap = await getDocs(
            query(collection(db, 'scores'), where('uid', '==', me.uid), limit(limitN))
          );
        }
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }

      function renderRows(rows) {
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#666;padding:24px">目前沒有任何成績紀錄</td></tr>`;
          return;
        }
        tbody.innerHTML = rows.map(r => {
          const submitted = fmtTime(r.submittedAt);
          const title = r.examTitle || r.examId || r.examType || '(未命名)';
          const dur = fmtDuration(r.timeSpentMs ?? r.durationMs ?? r.durationSec);
          return `<tr>
            <td class="exam-title">${title}</td>
            <td>${submitted}</td>
            <td>${scoreText(r)}</td>
            <td>${solvedText(r)}</td>
            <td>${dur}</td>
            <td><a class="btn" href="result.html?attemptId=${encodeURIComponent(r.id)}">查看</a></td>
          </tr>`;
        }).join('');
      }

      async function main() {
        try {
          onAuthStateChanged(auth, (u) => {
            console.log('🔐 auth 狀態：', u ? (u.isAnonymous ? '匿名-' + u.uid : (u.email || u.uid)) : '未登入');
          });

          const rows = await loadMyScores(50);
          renderRows(rows);
        } catch (e) {
          console.error('載入歷史成績失敗：', e.code, e.message);
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#b91c1c;padding:24px">讀取失敗：${e.code || e.message}</td></tr>`;
        }
      }

      main();
    </script>
</body>
</html>
