<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼·ç‰ˆå­¸ç¿’æ™‚é–“è¿½è¹¤æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .time-display {
            font-size: 28px;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .status-display {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .status-item {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }
        .button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1976D2;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #218838;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
            margin: 20px 0;
        }
        .warning {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¢å¼·ç‰ˆå­¸ç¿’æ™‚é–“è¿½è¹¤æ¸¬è©¦</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ æ¸¬è©¦èªªæ˜</h3>
            <p>æ­¤æ¸¬è©¦é é¢ç”¨æ–¼é©—è­‰å¢å¼·ç‰ˆå­¸ç¿’æ™‚é–“è¿½è¹¤åŠŸèƒ½ï¼š</p>
            <ul>
                <li>âœ… è·¨é é¢æŒçºŒè¨ˆæ™‚ï¼ˆåœ¨ç¶²ç«™å…§è·³è½‰é é¢æ™‚ç¹¼çºŒè¨ˆæ™‚ï¼‰</li>
                <li>âœ… é é¢å¯è¦‹æ€§æª¢æ¸¬ï¼ˆåˆ‡æ›åˆ°å…¶ä»–æ¨™ç±¤é æ™‚åœæ­¢è¨ˆæ™‚ï¼‰</li>
                <li>âœ… è¦–çª—ç„¦é»æª¢æ¸¬ï¼ˆåˆ‡æ›åˆ°å…¶ä»–æ‡‰ç”¨ç¨‹å¼æ™‚åœæ­¢è¨ˆæ™‚ï¼‰</li>
                <li>âœ… ç™»å‡ºæ™‚è‡ªå‹•ä¿å­˜æ™‚é–“åˆ°Firebase</li>
                <li>âœ… ä¸‹æ¬¡ç™»å…¥æ™‚å¾Firebaseè¼‰å…¥æ­·å²æ™‚é–“ä¸¦ç¹¼çºŒç´¯åŠ </li>
            </ul>
        </div>

        <div class="test-section">
            <h3>â° å­¸ç¿’æ™‚é–“é¡¯ç¤º</h3>
            <div class="time-display" id="currentTime">0:00:00</div>
            
            <div class="status-display">
                <div class="status-item" id="pageVisibilityStatus">
                    <div>é é¢å¯è¦‹æ€§</div>
                    <div id="visibilityText">æª¢æŸ¥ä¸­...</div>
                </div>
                <div class="status-item" id="windowFocusStatus">
                    <div>è¦–çª—ç„¦é»</div>
                    <div id="focusText">æª¢æŸ¥ä¸­...</div>
                </div>
                <div class="status-item" id="clockStatus">
                    <div>æ™‚é˜ç‹€æ…‹</div>
                    <div id="clockText">æª¢æŸ¥ä¸­...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ™‚é–“çµ±è¨ˆ</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="firebaseTime">0</div>
                    <div class="stat-label">Firebaseç¸½æ™‚é–“ (ç§’)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accumulatedTime">0</div>
                    <div class="stat-label">ç´¯ç©æ™‚é–“ (ç§’)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="effectiveTime">0</div>
                    <div class="stat-label">ç•¶å‰æœ‰æ•ˆæ™‚é–“ (ç§’)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTime">0</div>
                    <div class="stat-label">ç¸½è¨ˆæ™‚é–“ (ç§’)</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ® æ¸¬è©¦æ§åˆ¶</h3>
            <button class="button" onclick="startClock()">å•Ÿå‹•æ™‚é˜</button>
            <button class="button" onclick="stopClock()">åœæ­¢æ™‚é˜</button>
            <button class="button" onclick="resetClock()">é‡ç½®æ™‚é˜</button>
            <button class="button success" onclick="saveToFirebase()">ä¿å­˜åˆ°Firebase</button>
            <button class="button" onclick="loadFromFirebase()">å¾Firebaseè¼‰å…¥</button>
            <button class="button danger" onclick="simulateLogout()">æ¨¡æ“¬ç™»å‡º</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª åŠŸèƒ½æ¸¬è©¦</h3>
            <div class="warning">
                <strong>æ¸¬è©¦æç¤ºï¼š</strong>
                <ul>
                    <li>åˆ‡æ›åˆ°å…¶ä»–ç€è¦½å™¨æ¨™ç±¤é ï¼Œè§€å¯Ÿè¨ˆæ™‚æ˜¯å¦åœæ­¢</li>
                    <li>åˆ‡æ›åˆ°å…¶ä»–æ‡‰ç”¨ç¨‹å¼ï¼Œè§€å¯Ÿè¨ˆæ™‚æ˜¯å¦åœæ­¢</li>
                    <li>å›åˆ°æ­¤é é¢ï¼Œè§€å¯Ÿè¨ˆæ™‚æ˜¯å¦æ¢å¾©</li>
                    <li>åœ¨ç¶²ç«™å…§è·³è½‰åˆ°å…¶ä»–é é¢ï¼Œè§€å¯Ÿè¨ˆæ™‚æ˜¯å¦ç¹¼çºŒ</li>
                </ul>
            </div>
            
            <button class="button" onclick="openNewTab()">æ‰“é–‹æ–°æ¨™ç±¤é </button>
            <button class="button" onclick="simulatePageHide()">æ¨¡æ“¬é é¢éš±è—</button>
            <button class="button" onclick="simulatePageShow()">æ¨¡æ“¬é é¢é¡¯ç¤º</button>
            <button class="button" onclick="simulateWindowBlur()">æ¨¡æ“¬è¦–çª—å¤±ç„¦</button>
            <button class="button" onclick="simulateWindowFocus()">æ¨¡æ“¬è¦–çª—ç²ç„¦</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h3>
            <div id="testLog" class="log"></div>
            <button class="button" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
        </div>
    </div>

    <!-- è¼‰å…¥å­¸ç¿’æ™‚é–“æ™‚é˜æœå‹™ -->
    <script src="./src/services/learningTimeClockService.js"></script>

    <script>
        // æ¸¬è©¦æ—¥èªŒ
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[æ¸¬è©¦] ${message}`);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatusDisplay() {
            const service = window.learningTimeClockService;
            
            // é é¢å¯è¦‹æ€§ç‹€æ…‹
            const visibilityStatus = document.getElementById('pageVisibilityStatus');
            const visibilityText = document.getElementById('visibilityText');
            const isVisible = service ? service.isPageVisible : !document.hidden;
            
            visibilityStatus.className = `status-item ${isVisible ? 'status-active' : 'status-inactive'}`;
            visibilityText.textContent = isVisible ? 'å¯è¦‹' : 'éš±è—';
            
            // è¦–çª—ç„¦é»ç‹€æ…‹
            const focusStatus = document.getElementById('windowFocusStatus');
            const focusText = document.getElementById('focusText');
            const isFocused = service ? service.isWindowFocused : document.hasFocus();
            
            focusStatus.className = `status-item ${isFocused ? 'status-active' : 'status-inactive'}`;
            focusText.textContent = isFocused ? 'æœ‰ç„¦é»' : 'ç„¡ç„¦é»';
            
            // æ™‚é˜ç‹€æ…‹
            const clockStatus = document.getElementById('clockStatus');
            const clockText = document.getElementById('clockText');
            const isRunning = service ? service.isRunning : false;
            
            clockStatus.className = `status-item ${isRunning ? 'status-active' : 'status-inactive'}`;
            clockText.textContent = isRunning ? 'é‹è¡Œä¸­' : 'å·²åœæ­¢';
        }

        // æ›´æ–°æ™‚é–“çµ±è¨ˆ
        function updateTimeStats() {
            const service = window.learningTimeClockService;
            
            if (service && service.isInitialized) {
                document.getElementById('firebaseTime').textContent = service.totalTimeSpent || 0;
                document.getElementById('accumulatedTime').textContent = service.accumulatedTime || 0;
                document.getElementById('effectiveTime').textContent = Math.floor(service.calculateEffectiveTime() || 0);
                document.getElementById('totalTime').textContent = Math.floor(service.getCurrentTotalTime() || 0);
            }
        }

        // æ›´æ–°æ™‚é–“é¡¯ç¤º
        function updateTimeDisplay() {
            const service = window.learningTimeClockService;
            if (service && service.isInitialized) {
                const formattedTime = service.getCurrentFormattedTime();
                document.getElementById('currentTime').textContent = formattedTime;
            }
        }

        // å•Ÿå‹•æ™‚é˜
        function startClock() {
            const service = window.learningTimeClockService;
            if (service) {
                service.initialize().then(() => {
                    log('æ™‚é˜å·²å•Ÿå‹•', 'success');
                    updateStatusDisplay();
                });
            }
        }

        // åœæ­¢æ™‚é˜
        function stopClock() {
            const service = window.learningTimeClockService;
            if (service) {
                service.stop();
                log('æ™‚é˜å·²åœæ­¢', 'info');
                updateStatusDisplay();
            }
        }

        // é‡ç½®æ™‚é˜
        function resetClock() {
            const service = window.learningTimeClockService;
            if (service) {
                service.resetClock();
                log('æ™‚é˜å·²é‡ç½®', 'info');
                updateStatusDisplay();
            }
        }

        // ä¿å­˜åˆ°Firebase
        async function saveToFirebase() {
            const service = window.learningTimeClockService;
            if (service) {
                try {
                    const savedTime = await service.saveTimeToFirebase();
                    log(`ä¿å­˜åˆ°Firebaseå®Œæˆ: ${savedTime} ç§’`, 'success');
                    updateTimeStats();
                } catch (error) {
                    log(`ä¿å­˜åˆ°Firebaseå¤±æ•—: ${error.message}`, 'error');
                }
            }
        }

        // å¾Firebaseè¼‰å…¥
        async function loadFromFirebase() {
            const service = window.learningTimeClockService;
            if (service) {
                try {
                    await service.loadTotalTimeFromFirebase();
                    log('å¾Firebaseè¼‰å…¥å®Œæˆ', 'success');
                    updateTimeStats();
                    updateTimeDisplay();
                } catch (error) {
                    log(`å¾Firebaseè¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                }
            }
        }

        // æ¨¡æ“¬ç™»å‡º
        async function simulateLogout() {
            const service = window.learningTimeClockService;
            if (service && service.isInitialized) {
                try {
                    log('é–‹å§‹æ¨¡æ“¬ç™»å‡º...', 'info');
                    
                    // å¼·åˆ¶ä¿å­˜ç•¶å‰ç´¯ç©æ™‚é–“
                    service.saveAccumulatedTime();
                    
                    // ä¿å­˜åˆ°Firebase
                    const savedTime = await service.saveTimeToFirebase();
                    
                    if (savedTime > 0) {
                        log(`ç™»å‡ºæ™‚å·²ä¿å­˜å­¸ç¿’æ™‚é–“: ${savedTime} ç§’`, 'success');
                    }
                    
                    // åœæ­¢æœå‹™
                    service.stop();
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å„²
                    localStorage.removeItem('pbls_user');
                    
                    log('æ¨¡æ“¬ç™»å‡ºå®Œæˆ', 'success');
                    updateStatusDisplay();
                } catch (error) {
                    log(`æ¨¡æ“¬ç™»å‡ºå¤±æ•—: ${error.message}`, 'error');
                }
            } else {
                log('æ™‚é˜æœå‹™æœªåˆå§‹åŒ–ï¼Œç„¡æ³•æ¨¡æ“¬ç™»å‡º', 'warning');
            }
        }

        // æ¸¬è©¦åŠŸèƒ½
        function openNewTab() {
            window.open('about:blank', '_blank');
            log('å·²æ‰“é–‹æ–°æ¨™ç±¤é ï¼Œè«‹è§€å¯Ÿè¨ˆæ™‚æ˜¯å¦åœæ­¢', 'info');
        }

        function simulatePageHide() {
            document.dispatchEvent(new Event('visibilitychange'));
            log('å·²æ¨¡æ“¬é é¢éš±è—äº‹ä»¶', 'info');
        }

        function simulatePageShow() {
            document.dispatchEvent(new Event('visibilitychange'));
            log('å·²æ¨¡æ“¬é é¢é¡¯ç¤ºäº‹ä»¶', 'info');
        }

        function simulateWindowBlur() {
            window.dispatchEvent(new Event('blur'));
            log('å·²æ¨¡æ“¬è¦–çª—å¤±ç„¦äº‹ä»¶', 'info');
        }

        function simulateWindowFocus() {
            window.dispatchEvent(new Event('focus'));
            log('å·²æ¨¡æ“¬è¦–çª—ç²ç„¦äº‹ä»¶', 'info');
        }

        // ç›£è½å­¸ç¿’æ™‚é–“æ›´æ–°äº‹ä»¶
        window.addEventListener('learningTimeUpdate', (event) => {
            updateTimeDisplay();
            updateTimeStats();
        });

        // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–
        document.addEventListener('visibilitychange', () => {
            const isVisible = !document.hidden;
            log(`é é¢å¯è¦‹æ€§è®ŠåŒ–: ${isVisible ? 'å¯è¦‹' : 'éš±è—'}`, 'info');
            updateStatusDisplay();
        });

        // ç›£è½è¦–çª—ç„¦é»è®ŠåŒ–
        window.addEventListener('focus', () => {
            log('è¦–çª—ç²å¾—ç„¦é»', 'info');
            updateStatusDisplay();
        });

        window.addEventListener('blur', () => {
            log('è¦–çª—å¤±å»ç„¦é»', 'info');
            updateStatusDisplay();
        });

        // å®šæœŸæ›´æ–°é¡¯ç¤º
        setInterval(() => {
            updateTimeDisplay();
            updateTimeStats();
            updateStatusDisplay();
        }, 1000);

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('å¢å¼·ç‰ˆå­¸ç¿’æ™‚é–“è¿½è¹¤æ¸¬è©¦é é¢å·²è¼‰å…¥', 'info');
            updateStatusDisplay();
            
            // è‡ªå‹•å•Ÿå‹•æ™‚é˜æœå‹™
            setTimeout(() => {
                startClock();
            }, 1000);
        });
    </script>
</body>
</html>
